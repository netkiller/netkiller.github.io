<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>3.3. nginx 配置文件</title><link rel="stylesheet" type="text/css" href="/docbook.css" /><meta name="generator" content="DocBook XSL Stylesheets V1.78.1" /><meta name="keywords" content="lamp,lnmp,famp,fnmp, cgi,fastcgi,wsgi, apache,lighttpd,nginx,tomcat, awstatus, webalizer" /><link rel="home" href="index.html" title="Netkiller Linux Web 手札" /><link rel="up" href="nginx.html" title="第 3 章 Nginx" /><link rel="prev" href="nginx.fastcgi.html" title="3.2. fastcgi" /><link rel="next" href="nginx.faq.html" title="3.4. FAQ" /></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">3.3. nginx 配置文件</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="nginx.fastcgi.html">上一页</a> </td><th width="60%" align="center">第 3 章 Nginx</th><td width="20%" align="right"> <a accesskey="n" href="nginx.faq.html">下一页</a></td></tr></table><hr /></div><table xmlns="" width="100%" border="0"><tr><td align="left"><a href="http://netkiller.github.io/">Home</a> |
        <a href="http://netkiller.sourceforge.net/">Mirror</a> |
        <a href="/search.html">Search</a></td><td><a href="http://netkiller-github-com.iteye.com/">ITEYE 博客</a> |
        <a href="http://my.oschina.net/neochen/">OSChina 博客</a> |
        <a href="http://rline.blog.51cto.com/">51CTO 博客</a></td><td><form id="searchbox_008589143145807374698:f5uprauilyy" action="/search.html"><input type="hidden" name="cx" value="008589143145807374698:f5uprauilyy" /><input type="hidden" name="cof" value="FORID:11" /><input name="q" type="text" size="25" style="border-top-width: 1px; border-right-width: 1px; border-bottom-width: 1px; border-left-width: 1px; border-top-style: solid; border-right-style: solid; border-bottom-style: solid; border-left-style: solid; border-top-color: rgb(126, 157, 185); border-right-color: rgb(126, 157, 185); border-bottom-color: rgb(126, 157, 185); border-left-color: rgb(126, 157, 185); padding-top: 2px; padding-right: 2px; padding-bottom: 2px; padding-left: 2px; background-image: url(http://www.google.com/cse/intl/en/images/google_custom_search_watermark.gif); background-attachment: initial; background-origin: initial; background-clip: initial; background-color: rgb(255, 255, 255); background-position: 0% 50%; background-repeat: no-repeat no-repeat; " /><input type="submit" name="sa" value="Search" /><input name="siteurl" type="hidden" value="http://netkiller.sourceforge.net/" /></form><script type="text/javascript" src="http://www.google.com/coop/cse/brand?form=searchbox_008589143145807374698%3Af5uprauilyy"></script></td></tr></table><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="nginx.conf"></a>3.3. nginx 配置文件</h2></div></div></div>
	
	<p>worker_processes = CPU 数量</p>
	<pre class="screen">
user  www;
worker_processes  1;

error_log  /var/log/nginx/error.log warn;
pid        /var/run/nginx.pid;
	</pre>
	<div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="nginx.events"></a>3.3.1. events</h3></div></div></div>
		
		<pre class="screen">
events {
    worker_connections  4096;
}
		</pre>
	</div>

	<div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="nginx.http"></a>3.3.2. http 配置</h3></div></div></div>
		

		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idp65243856"></a>3.3.2.1. X-Forwarded-For</h4></div></div></div>
			
			<pre class="screen">
real_ip_header X-Forwarded-For;
			</pre>
		</div>

		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="nginx.gzip"></a>3.3.2.2. gzip</h4></div></div></div>
			
			<pre class="screen">
gzip  on;
gzip_min_length  1000;
gzip_buffers     4 8k;
gzip_types       text/plain application/x-javascript text/css text/html application/xml;


gzip on;
gzip_http_version 1.0;
gzip_disable "MSIE [1-6].";
gzip_types text/plain application/x-javascript text/css text/javascript;
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="nginx.server_tokens"></a>3.3.2.3. server_tokens</h4></div></div></div>
			
			<p>隐藏nginx版本号</p>
			<pre class="screen">
http {
...
server_tokens off;
...
}
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="nginx.ssi"></a>3.3.2.4. ssi</h4></div></div></div>
			
			<pre class="screen">
http {
  ssi  on;
}

location / {
  ssi on;
  ssi_silent_errors on;
  ssi_types text/shtml;
}
		</pre>
		<pre class="screen">
ssi on;
ssi_silent_errors on;
ssi_types text/shtml;
ssi_value_length 256;
server_names_hash_bucket_size 128;
client_header_buffer_size 32k;
large_client_header_buffers 4 32k;
client_max_body_size 8m;
			</pre>
		</div>
	</div>

	<div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="nginx.http.server"></a>3.3.3. server</h3></div></div></div>
		
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="nginx.http.server"></a>3.3.3.1. 单域名虚拟主机</h4></div></div></div>
			
			<pre class="screen">
# cat /etc/nginx/conf.d/images.conf
server {
    listen       80;
    server_name  images.example.com;

    #charset koi8-r;
    access_log  /var/log/nginx/images.access.log  main;

    location / {
        root   /www/images;
        index  index.html index.htm;
    }

    #error_page  404              /404.html;

    # redirect server error pages to the static page /50x.html
    #
    error_page   500 502 503 504  /50x.html;
    location = /50x.html {
        root   /usr/share/nginx/html;
    }

    # proxy the PHP scripts to Apache listening on 127.0.0.1:80
    #
    #location ~ \.php$ {
    #    proxy_pass   http://127.0.0.1;
    #}

    # pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000
    #
    #location ~ \.php$ {
    #    root           html;
    #    fastcgi_pass   127.0.0.1:9000;
    #    fastcgi_index  index.php;
    #    fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;
    #    include        fastcgi_params;
    #}

    # deny access to .htaccess files, if Apache's document root
    # concurs with nginx's one
    #
    #location ~ /\.ht {
    #    deny  all;
    #}
}
			</pre>
			<p>绑定多个域名</p>
			<pre class="screen">
server_name  images.example.com img1.example.com img2.example.com;
			</pre>
			<p>使用通配符匹配</p>
			<pre class="screen">
server_name  *.example.com
server_name  www.*;
			</pre>
			<p>正则匹配</p>
			<pre class="screen">
server_name ~^(.+)\.example\.com$;
server_name ~^(www\.)?(.+)$;
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="nginx.http.server.ssl"></a>3.3.3.2. ssl 虚拟主机</h4></div></div></div>
			
			<pre class="screen">
mkdir /etc/nginx/ssl
			</pre>
			<p>cp your_ssl_certificate to /etc/nginx/ssl</p>
			<pre class="screen">
# HTTPS server
#
server {
	listen 443;
	server_name localhost;

	root html;
	index index.html index.htm;

	ssl on;
	#ssl_certificate cert.pem;
	ssl_certificate ssl/example.com.pem;
	ssl_certificate_key ssl/example.com.key;

	ssl_session_timeout 5m;

	ssl_protocols SSLv3 TLSv1;
	ssl_ciphers ALL:!ADH:!EXPORT56:RC4+RSA:+HIGH:+MEDIUM:+LOW:+SSLv3:+EXP;
	ssl_prefer_server_ciphers on;

	location / {
		try_files $uri $uri/ /index.html;
	}
}
			</pre>
			<p>configtest</p>
			<pre class="screen">
$ sudo service nginx configtest
Testing nginx configuration: nginx.
			</pre>
			<p>443 port test</p>
			<pre class="screen">
$ openssl s_client -connect www.example.com:443
			</pre>
		</div>

		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="nginx.http.server.subdomain"></a>3.3.3.3. 泛解析主机</h4></div></div></div>
			
			<pre class="screen">
server {
	listen       80;
	server_name  *.example.com example.com;
	if ($host = 'example.com' ) {
		rewrite ^/(.*)$ http://www.example.com/$1 permanent;
	}

	if ( $host ~* (.*)\.(.*)\.(.*)) {
		set $subdomain $1;
		set $domain $2.$3;
	}

	root  /www/$domain/$subdomain;
	index index.html index.php;

	location ~ .*\.(php|shtml)?$ {
		fastcgi_pass  127.0.0.1:9000;
		fastcgi_index index.php;
		include fcgi.conf;
	}
}
			</pre>
			<p>或者采用这种格式 /www/example.com/www.example.com</p>
			<pre class="screen">
root  /www/$domain/$host;
			</pre>
			<p>更简洁的方法，只需在 /www/下面创建 域名目录即可例如/www/www.example.com</p>
			<pre class="screen">
server {
	listen       80;
	server_name  *.example.com example.com;
	if ($host = 'example.com' ) {
		rewrite ^/(.*)$ http://www.example.com/$1 permanent;
	}

	root  /www/$host;
	index index.html index.php;

	location ~ .*\.(php|shtml)?$ {
		fastcgi_pass  127.0.0.1:9000;
		fastcgi_index index.php;
		include fcgi.conf;
	}
}
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="nginx.http.server.location"></a>3.3.3.4. location</h4></div></div></div>
			
			<pre class="screen">
    location / {
        root   /www;
        index  index.html index.htm;
    }
			</pre>
			<pre class="screen">
    location ~ ^/(config|include)/ {
        deny all;
        break;
    }
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="nginx.expires"></a>3.3.3.5. expires</h4></div></div></div>
			
			<p>expires 格式</p>
			<div class="example"><a id="idp65271520"></a><p class="title"><strong>例 3.1. Expires Examples</strong></p><div class="example-contents">
				
				<pre class="screen">
expires 1 January, 1970, 00:00:01 GMT;
expires 60s;
expires 30m;
expires 24h;
expires 1d;
expires max;
expires off;

expires       24h;
expires       modified +24h;
expires       @15h30m;
expires       0;
expires       -1;
expires       epoch;
add_header    Cache-Control  private;
				</pre>
				<p>注意：expires仅仅适用于200, 204, 301, 302,304</p>
			</div></div><br class="example-break" />
			<p>单个文件匹配</p>
			<pre class="screen">
    location ~* \.css$ {
       expires 30d;
    }
			</pre>
			<p>扩展名匹配</p>
			<pre class="screen">
#图片类资源缓存5天，并且不记录请求日志
location ~ .*\.(ico|gif|jpg|jpeg|png|bmp|swf)$
{
        expires      5d;
        access_log off;
}

#css/js 缓存一天，不记录请求日志
location ~ .*\.(js|css)$
{
        expires      1d;
        access_log off;
}
			</pre>

			<pre class="screen">
location ~ .*\.(htm|html|gif|jpg|jpeg|png|bmp|swf|ioc|rar|zip|txt|flv|mid|doc|ppt|pdf|xls|mp3|wma)$
{
    expires      30d;
}
location ~ .*\.(js|css)$
{
    expires      1h;
}
			</pre>
			<pre class="screen">
location ~* \.(js|css|jpg|jpeg|gif|png|swf)$ {
	if (-f $request_filename) {
	   expires    1h;
	   break;
	}
}

location ~* \.(jpg|jpeg|gif|css|png|js|ico)$ {
	expires max;
}

#cache control: all statics are cacheable for 24 hours
location / {
        if ($request_uri ~* \.(ico|css|js|gif|jpe?g|png)$) {
                expires 72h;
                break;
        }
}
			</pre>
			<p>add_header 实例</p>
			<pre class="screen">
location ~* \.(?:ico|css|js|gif|jpe?g|png)$ {
    expires 30d;
    add_header Pragma public;
    add_header Cache-Control "public";
}
			</pre>
			<div class="example"><a id="idp65278320"></a><p class="title"><strong>例 3.2. nginx expires</strong></p><div class="example-contents">
				
				<pre class="screen">
location ~ .*\.(gif|jpg|jpeg|png|bmp|swf|ico)$ {
    expires      1d;
    access_log   off;
}

location ~ .*\.(js|css)$ {
    expires      1d;
    access_log   off;
}
location ~ .*\.(html|htm)$
{
    expires      1d;
    access_log off;
}
				</pre>
			</div></div><br class="example-break" />
		</div>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="nginx.access"></a>3.3.3.6. access</h4></div></div></div>
			
			<pre class="screen">
#防止access文件被下载
location ~ /\.ht {
    deny  all;
}
			</pre>
			<pre class="screen">
location ~ ^/upload/.*\.php$
{
        deny all;
}

location ~ ^/static/images/.*\.php$
{
        deny all;
}
			</pre>
			<pre class="screen">
location ~ /\.ht {
    deny all;
}

location ~ .*\.(sqlite|sq3)$ {
    deny all;
}
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="nginx.auth_basic"></a>3.3.3.7. auth_basic</h4></div></div></div>
			
			<pre class="screen">
cd /usr/local/nginx/conf
server {
	listen 80;
	server_name www.example.com;
	root /var/www/htdocs;
	index index.html;

	location / {
		try_files $uri $uri/ /index.html;
		auth_basic            "Login";
        auth_basic_user_file  htpasswd;
	}
}
			</pre>
			<p>生成密码文件</p>
			<pre class="screen">
$ sudo apt-get install apache2-utils

htpasswd -c -d htpasswd user_name
			</pre>
			<div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[提示]" src="/graphics/tip.png" /></td><th align="left">提示</th></tr><tr><td align="left" valign="top">
				<p>必须使用 -d  Force CRYPT encryption of the password. 选项，</p>
			</td></tr></table></div>
		</div>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="nginx.autoindex"></a>3.3.3.8. autoindex</h4></div></div></div>
			
			<pre class="screen">
# vim /etc/nginx/sites-enabled/default

location  /  {
  autoindex  on;
}
			</pre>
			<pre class="screen">
# /etc/init.d/nginx reload
Reloading nginx configuration: nginx.
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="nginx.rewrite"></a>3.3.3.9. rewrite</h4></div></div></div>
			
			<pre class="screen">
Rewrite Flags
last - 基本上都用这个Flag。
break - 中止Rewirte，不在继续匹配
redirect - 返回临时重定向的HTTP状态302
permanent - 返回永久重定向的HTTP状态301

文件及目录匹配，其中：
-f和!-f用来判断是否存在文件
-d和!-d用来判断是否存在目录
-e和!-e用来判断是否存在文件或目录
-x和!-x用来判断文件是否可执行

正则表达式全部符号解释
~ 为区分大小写匹配
~* 为不区分大小写匹配
!~和!~* 分别为区分大小写不匹配及不区分大小写不匹配
(pattern) 匹配 pattern 并获取这一匹配。所获取的匹配可以从产生的 Matches 集合得到，在VBScript 中使用 SubMatches 集合，在JScript 中则使用 $0…$9 属性。要匹配圆括号字符，请使用 ‘\(’ 或 ‘\)’。
^ 匹配输入字符串的开始位置。
$ 匹配输入字符串的结束位置。
			</pre>
			<pre class="screen">
server {
	listen 80;
	server_name www.example.com example.com ;
	if ($host = "example.com" )
	{
		rewrite ^/(.*)$ http://www.example.com/$1 permanent;
	}
	if ($host != "www.example.com" )
	{
		rewrite ^/(.*)$ http://www.example.com/$1 permanent;
	}
}
			</pre>
			<pre class="screen">
location ~* \.(js|css|jpg|jpeg|gif|png|swf)$ {
	if (!-f $request_filename){
	        rewrite /(.*) http://images.example.com/$1;
	}
}
			</pre>
			<pre class="screen">
if ($host ~ '(.*)\.static\.example\.com' ) {
    set $subdomain $1;
    rewrite  "^/(.*)$"  /$subdomain/$1;
}
			</pre>
		</div>


		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="nginx.cache"></a>3.3.3.10. Cache</h4></div></div></div>
			
			<pre class="screen">
			
add_header     Nginx-Cache     "HIT  from  www.example.com";
or
add_header     Nginx-Cache     "$upstream_cache_status  from  www.example.com";
			
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="nginx.stub_status"></a>3.3.3.11. stub_status</h4></div></div></div>
			
			<pre class="screen">
location /nginx_status {
	stub_status on;
	access_log  off;
	allow 127.0.0.1;
	deny all;
}
			</pre>
		</div>

		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="nginx.add_header"></a>3.3.3.12. add_header</h4></div></div></div>
			
			<p># 相关页面设置Cache-Control头信息</p>
			<pre class="screen">
      if ($request_uri ~* "^/$|^/news/.+/|^/info/.+/") {
        add_header    Cache-Control  max-age=3600;
      }

      if ($request_uri ~* "^/suggest/|^/categories/") {
        add_header    Cache-Control  max-age=86400;
      }
			</pre>
			<div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="idp65298560"></a>3.3.3.12.1. Access-Control-Allow</h5></div></div></div>
				
				<pre class="screen">
location ~* \.(eot|ttf|woff)$ {
    add_header Access-Control-Allow-Origin *;
}

location /js/ {
add_header Access-Control-Allow-Origin https://www.mydomain.com/;
add_header Access-Control-Allow-Methods GET,OPTIONS;
add_header Access-Control-Allow-Headers *;
}
				</pre>
				<pre class="screen">
location / {
    if ($request_method = OPTIONS ) {
        add_header Access-Control-Allow-Origin "http://example.com";
        add_header Access-Control-Allow-Methods "GET, OPTIONS";
        add_header Access-Control-Allow-Headers "Authorization";
        add_header Access-Control-Allow-Credentials "true";
        add_header Content-Length 0;
        add_header Content-Type text/plain;
        return 200;
    }
}
				</pre>
			</div>
		</div>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="valid_referers"></a>3.3.3.13. valid_referers</h4></div></div></div>
			
			<div class="example"><a id="idp65302176"></a><p class="title"><strong>例 3.3. Example: valid_referers</strong></p><div class="example-contents">
				
				<pre class="screen">
location /photos/ {
  valid_referers none blocked www.mydomain.com mydomain.com;

  if ($invalid_referer) {
    return   403;
  }
}
				</pre>
				<pre class="screen">
location ~* \.(gif|jpg|jpeg|png|bmp|txt|zip|jar|swf)$ {
	valid_referers none blocked *.mydomain.com;
	if ($invalid_referer) {
		rewrite ^/  http://www.mydomain.com/default.gif;
		#return 403;
	}

}

location /images/ {
	alias /www/images/;
	valid_referers none blocked *.mydomain.com;
	if ($invalid_referer) {
		rewrite ^/  http://www.mydomain.com/default.gif;
	}
}
				</pre>
			</div></div><br class="example-break" />
		</div>
	</div>
	<div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="nginx.proxy"></a>3.3.4. Proxy</h3></div></div></div>
		
		<pre class="screen">
# cat /etc/nginx/nginx.conf

#user  nobody;
worker_processes  4;

#error_log  logs/error.log;
#error_log  logs/error.log  notice;
#error_log  logs/error.log  info;

#pid        logs/nginx.pid;


events {
    worker_connections  40960;
        use epoll;
}


http {
    include       mime.types;
    default_type  application/octet-stream;

    #log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
    #                  '$status $body_bytes_sent "$http_referer" '
    #                  '"$http_user_agent" "$http_x_forwarded_for"';

    #access_log  logs/access.log  main;

    access_log  /dev/null;

    sendfile        on;
    #tcp_nopush     on;

    #keepalive_timeout  0;
    keepalive_timeout  65;

    #gzip  on;

upstream backend{
#        server 172.16.0.6:80;
        server 10.0.0.68:80;
        server 10.0.0.69:80;
}


    server {
        listen       80;
        server_name  localhost;

        #charset koi8-r;

        #access_log  logs/host.access.log  main;

#        location / {
#            root   html;
#            index  index.html index.htm;
#        }

    access_log  /dev/null;
    error_log   /dev/null;


    location / {
#        proxy_pass $scheme://$host$request_uri;
#        proxy_set_header Host $http_host;

#        proxy_buffers 256 4k;
#        proxy_max_temp_file_size 0;

#        proxy_connect_timeout 30;

#        proxy_cache_valid 200 302 10m;
#        proxy_cache_valid 301 1h;
#        proxy_cache_valid any 1m;



         proxy_pass      http://backend;

         proxy_redirect          off;
         proxy_set_header        Host $host;
#         proxy_set_header        X-Real-IP $remote_addr;
#         proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
         client_max_body_size    10m;
         client_body_buffer_size 128k;
         proxy_connect_timeout   30;
         proxy_send_timeout      30;
         proxy_read_timeout      30;
         proxy_buffer_size       4k;
         proxy_buffers           256 4k;
         proxy_busy_buffers_size 64k;
         proxy_temp_file_write_size 64k;
        tcp_nodelay on;
    }


        #error_page  404              /404.html;

        # redirect server error pages to the static page /50x.html
        #
        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   html;
        }
    }

}
		</pre>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idp65308384"></a>3.3.4.1. request_filename + proxy_pass</h4></div></div></div>
			
			<p>如果文件不存在，那么去指定的节点上寻找</p>
			<pre class="screen">
   location / {
        root  /www;
        proxy_intercept_errors  on;
        if (!-f $request_filename) {
          proxy_pass http://172.16.1.1;
          break;
        }
    }
	location / {
        root  /www/images;
        proxy_intercept_errors  on;
        if (!-f $request_filename) {
          proxy_pass http://172.16.1.2;
          break;
        }
    }
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="proxy_cache"></a>3.3.4.2. proxy_cache</h4></div></div></div>
			
			<pre class="screen">
http {
  proxy_cache_path  /var/www/cache levels=1:2 keys_zone=my-cache:8m max_size=1000m inactive=600m;
  proxy_temp_path /var/www/cache/tmp;


  server {
    location / {
      proxy_pass http://example.net;
      proxy_cache mycache;
      proxy_cache_valid  200 302  60m;
      proxy_cache_valid  404      1m;
    }
  }
}
			</pre>
			<pre class="screen">
location / {
  proxy_pass http://localhost;
  proxy_set_header   Host             $host;
  proxy_set_header   X-Real-IP        $remote_addr;
  proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;
  proxy_ignore_headers Set-Cookie;
  proxy_ignore_headers Cache-Control;
  proxy_cache_bypass        $http_secret_header;
  add_header X-Cache-Status $upstream_cache_status;
}
			</pre>
			<pre class="screen">
server {
          listen       80;
          server_name  example.org;
          root   /var/www;
          index  index.html index.php;

	location ~* .+.(ico|jpg|gif|jpeg|css|js|flv|png|swf)$ {
           	expires max;
	}

	location / {
		proxy_pass       http://backend;
		proxy_set_header  X-Real-IP  $remote_addr;
		proxy_set_header Host $http_host;
		proxy_cache cache;
		proxy_cache_key $host$request_uri;
		proxy_cache_valid 200 304 12h;
		proxy_cache_valid 302 301 12h;
		proxy_cache_valid any 1m;
		proxy_ignore_headers Cache-Control Expires;
		proxy_pass_header Set-Cookie;
	}

}
			</pre>
		</div>

		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idp65314224"></a>3.3.4.3. expires</h4></div></div></div>
			
			<pre class="screen">
location / {
    root /var/www;
    proxy_set_header  X-Real-IP  $remote_addr;
    proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $http_host;
    proxy_redirect false;

    if ($request_uri ~* "\.(ico|css|js|gif|jpe?g|png)\?[0-9]+$") {
        expires max;
        break;
    }
    if (-f $request_filename) {
        break;
    }
    if (-f $request_filename/index.html) {
        rewrite (.*) $1/index.html break;
    }
    if (-f $request_filename.html) {
        rewrite (.*) $1.html break;
    }

    proxy_pass http://backend;
}
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="request_uri+proxy_pass"></a>3.3.4.4. $request_uri 与  proxy_pass 联合使用</h4></div></div></div>
			
			<pre class="screen">
server {
    listen       80;
    server_name  info.example.com;

    #charset koi8-r;
    access_log  /var/log/nginx/info.example.com.access.log  main;

    location / {
        root   /www/example.com/info.example.com;
        index  index.html index.htm;

	rewrite ^/$  http://www.example.com/;

	valid_referers none blocked *.example.com;
	if ($invalid_referer) {
		#rewrite ^(.*)$  http://www.example.com/cn/$1;
		return 403;
	}

        proxy_intercept_errors  on;
#	    proxy_set_header  X-Real-IP  $remote_addr;
#            proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;
#            proxy_set_header  Host            $host;
#
#            proxy_cache one;
#            proxy_cache_valid  200 302 304 10m;
#            proxy_cache_valid  301 1h;
#            proxy_cache_valid  any 1m;

        if ( $request_uri ~ "^/public/datas/(sge|cgse|futures|fx_price|gold_price|stock|bonds)\.xml$") {
                proxy_pass http://211.176.212.212$request_uri;
		break;
        }

        if (!-f $request_filename) {

          proxy_pass http://infoadmin.example.com;
          #proxy_pass http://backend;
          break;
        }
    }

    location ~ ^/index\.php$ {
	return 403;
    }
    location ~ ^/(config|include|crontab|/systemmanage)/ {
	deny all;
	break;
    }
    #error_page  404              /404.html;

    # redirect server error pages to the static page /50x.html
    #
    error_page   500 502 503 504  /50x.html;
    location = /50x.html {
        root   /usr/share/nginx/html;
    }

}
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="xsendfile"></a>3.3.4.5. X-Sendfile</h4></div></div></div>
			
			<p>http://wiki.nginx.org/NginxXSendfile</p>
			<pre class="screen">

			</pre>
		</div>
	</div>

	<div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="limit_zone"></a>3.3.5. limit_zone</h3></div></div></div>
		
		<pre class="screen">
limit_zone   one  $binary_remote_addr  10m;

server {
	location /download/ {
	limit_conn   one  1;
}
		</pre>
	</div>

	

<div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="nginx.var"></a>3.3.6. Nginx 变量</h3></div></div></div>
	
	<p>可用的全局变量</p>
	<pre class="screen">
$args
$content_length
$content_type
$document_root
$document_uri
$host
$http_user_agent
$http_cookie
$http_referer
$limit_rate
$request_body_file
$request_method
$remote_addr
$remote_port
$remote_user
$request_filename
$request_uri
$query_string
$scheme
$server_protocol
$server_addr
$server_name
$server_port
$uri
	</pre>
	<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="http_user_agent"></a>3.3.6.1. http_user_agent</h4></div></div></div>
		
		<pre class="screen">
## Block http user agent - wget ##
if ($http_user_agent ~* (Wget|Curl) ) {
   return 403;
}

## Block Software download user agents ##
if ($http_user_agent ~* LWP::Simple|BBBike|wget) {
       return 403;
}

if ($http_user_agent ~ (msnbot|scrapbot) ) {
    return 403;
}


if ($http_user_agent ~ (Spider|Robot) ) {
    return 403;
}

		</pre>
		<div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="idp65325664"></a>3.3.6.1.1. 禁止非浏览器访问</h5></div></div></div>
			
			<p>禁止非浏览器访问</p>
			<pre class="screen">
if ($http_user_agent ~ ^$) {
	return 412;
}
			</pre>
			<p>测试是否生效</p>
			<pre class="screen">
tail -f /var/log/nginx/www.mydomain.com.access.log
			</pre>
			<pre class="screen">
telnet 192.168.2.10 80
GET /index.html HTTP/1.0
Host: www.mydomain.com
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="idp65330624"></a>3.3.6.1.2. http_user_agent 没有设置不允许访问</h5></div></div></div>
			
			<pre class="screen">
	if ($http_user_agent = "") { return 403; }
			</pre>
			<p>验证测试，首先使用curl -A 指定一个 空的User Agent，应该返回 403.</p>
			<pre class="screen">
			
curl -A ""  http://www.example.com/xml/data.json

&lt;html&gt;
&lt;head&gt;&lt;title&gt;403 Forbidden&lt;/title&gt;&lt;/head&gt;
&lt;body bgcolor="white"&gt;
&lt;center&gt;&lt;h1&gt;403 Forbidden&lt;/h1&gt;&lt;/center&gt;
&lt;hr&gt;&lt;center&gt;nginx&lt;/center&gt;
&lt;/body&gt;
&lt;/html&gt;
			
			</pre>
		</div>
	</div>
	<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="http_referer"></a>3.3.6.2. http_referer</h4></div></div></div>
		
		<pre class="screen">
if ($http_referer ~* "PHP/5.2.14"){return 403;}
		</pre>
		<div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="idp65335088"></a>3.3.6.2.1. valid_referers/invalid_referer</h5></div></div></div>
			
			<pre class="screen">
valid_referers none blocked *.example.com example.com;
if ($invalid_referer) {
	#rewrite ^(.*)$  http://www.example.com/cn/$1;
	return 403;
}
			</pre>
		</div>
	</div>
	<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="request_filename"></a>3.3.6.3. request_filename</h4></div></div></div>
		
		<pre class="screen">
    location / {
        root   /www/mydomain.com/info.mydomain.com;
        index  index.html;

		rewrite ^/$  http://www.mydomain.com/;

		valid_referers none blocked *.mydomain.com;
		if ($invalid_referer) {
			return 403;
		}

        proxy_intercept_errors  on;
	    proxy_set_header  X-Real-IP  $remote_addr;
        proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header  Host            $host;


        if (!-f $request_filename) {
          proxy_pass http://old.mydomain.com;
          break;
        }
    }
		</pre>
	</div>
	<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="request_uri"></a>3.3.6.4. request_uri</h4></div></div></div>
		
		<pre class="screen">
server {
    listen       80;
    server_name  quote.mydomain.com;

    charset utf-8;
    access_log  /var/log/nginx/quote.mydomain.com.access.log  main;

    location / {
        root   /www/mydomain.com/info.mydomain.com;
        index  index.html ;

		rewrite ^/$  http://www.mydomain.com/;

		valid_referers none blocked *.mydomain.com;
		if ($invalid_referer) {
			#rewrite ^(.*)$  http://www.mydomain.com/cn/$1;
			return 403;
		}

        proxy_intercept_errors  on;
	    proxy_set_header  X-Real-IP  $remote_addr;
        proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header  Host            $host;

		if ( $request_uri ~ "^/xml/(sge|cgse|futures|stock|bonds)\.xml$") {
              proxy_pass http://21.16.22.12/$request_uri;
		break;
        }

        if (!-f $request_filename) {
	          proxy_pass http://cms.mydomain.com;
	          break;
        }

    }

    location ~ \.xml$ {
        proxy_pass http://21.16.22.12/public/datas$request_uri;
        break;
    }

    location ~* ^/public/datas/\w+\.xml$ {
        proxy_pass http://21.16.22.12/$request_uri;
        break;
    }
}
		</pre>
		<pre class="screen">
#add for yiiframework
        if (!-e $request_filename){
                   rewrite (.*) /index.php break;
        }

        location ~ .*\.php?$
        {
                  #fastcgi_pass  unix:/tmp/php-cgi.sock;
                  include fcgi.conf;
                  fastcgi_pass  127.0.0.1:10080;
                  fastcgi_index index.php;

                  set $path_info $request_uri;

                  if ($request_uri ~ "^(.*)(\?.*)$") {
                        set $path_info $1;
                  }
                  fastcgi_param PATH_INFO $path_info;
        }
#end for yiiframework
		</pre>
	</div>
	<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="remote_addr"></a>3.3.6.5. remote_addr</h4></div></div></div>
		
		<pre class="screen">
location /name/(match) {
    if ($remote_addr !~ ^10.10.20) {
        limit_rate 10k;
    }

    proxy_buffering off;
    proxy_pass http://10.10.20.1/${1}.html;
}
		</pre>
		<pre class="screen">
location ~ /(\d+) {
    if ($remote_addr ~ (\d+)\.\d+\.) {

    }

    echo $1;
}
		</pre>
		<pre class="screen">
$ curl 127.0.0.1/134
127

$ curl 192.168.0.1/134
192
		</pre>
	</div>
	<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idp65345072"></a>3.3.6.6. 自定义变量</h4></div></div></div>
		
		<pre class="screen">
if ( $host ~* (.*)\.(.*)\.(.*)) {
	set $subdomain $1;
}
location / {
    root  html/$subdomain;
    index index.html index.php;
}
		</pre>
		<pre class="screen">
if ( $host ~* (\b(?!www\b)\w+)\.\w+\.\w+ ) {
    set $subdomain /$1;
}

location / {
    root /www/public_html$subdomain;
    index index.html index.php;
}
		</pre>
	</div>
</div>
</div><div xmlns="" id="bdshare" class="bdshare_t bds_tools_32 get-codes-bdshare"><a class="bds_fbook"></a><a class="bds_twi"></a><a class="bds_ms"></a><a class="bds_msn"></a><a class="bds_buzz"></a><a class="bds_linkedin"></a><a class="bds_deli"></a><a class="bds_qzone"></a><a class="bds_qq"></a><a class="bds_tqq"></a><a class="bds_tqf"></a><a class="bds_tsina"></a><a class="bds_baidu"></a><a class="bds_renren"></a><a class="bds_t163"></a><a class="bds_tfh"></a><a class="bds_douban"></a><a class="bds_hi"></a><a class="bds_tieba"></a><a class="bds_tsohu"></a><span class="bds_more"></span><a class="shareCount"></a></div><script xmlns="" type="text/javascript" id="bdshare_js" data="type=tools"></script><script xmlns="" type="text/javascript" id="bdshell_js"></script><script xmlns="" type="text/javascript">
	document.getElementById("bdshell_js").src = "http://bdimg.share.baidu.com/static/js/shell_v2.js?cdnversion=" + new Date().getHours();
</script><div xmlns="" id="disqus_thread"></div><script xmlns="" type="text/javascript">
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */

            if(document.domain == 'netkiller.github.com'){
            var disqus_shortname = 'netkiller'; // required: replace example with your forum shortname
            }else{
			var disqus_shortname = 'netkiller';
            }

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script><noscript xmlns="">Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript><a xmlns="" href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a><br xmlns="" /><div xmlns="" id="clustrmaps-widget"></div><script xmlns="" type="text/javascript">var _clustrmaps = {'url' : 'http://netkiller.github.io', 'user' : 1107643, 'server' : '2', 'id' : 'clustrmaps-widget', 'version' : 1, 'date' : '2013-08-14', 'lang' : 'en', 'corners' : 'square' };(function (){ var s = document.createElement('script'); s.type = 'text/javascript'; s.async = true; s.src = 'http://www2.clustrmaps.com/counter/map.js'; var x = document.getElementsByTagName('script')[0]; x.parentNode.insertBefore(s, x);})();</script><noscript xmlns=""><a href="http://www2.clustrmaps.com/user/87410e6bb"><img src="http://www2.clustrmaps.com/stats/maps-no_clusters/netkiller.github.io-thumb.jpg" alt="Locations of visitors to this page" /></a></noscript><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="nginx.fastcgi.html">上一页</a> </td><td width="20%" align="center"><a accesskey="u" href="nginx.html">上一级</a></td><td width="40%" align="right"> <a accesskey="n" href="nginx.faq.html">下一页</a></td></tr><tr><td width="40%" align="left" valign="top">3.2. fastcgi </td><td width="20%" align="center"><a accesskey="h" href="index.html">起始页</a></td><td width="40%" align="right" valign="top"> 3.4. FAQ</td></tr></table></div><script xmlns="" type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-11694057-1']);
  _gaq.push(['_setDomainName', 'netkiller.github.io']);
  _gaq.push(['_setAllowLinker', true]);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script><script xmlns="" type="text/javascript">
var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3F997cd4a7320a82d72cb74d179118f697' type='text/javascript'%3E%3C/script%3E"));
</script></body></html>