<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>41.2. iptables - administration tools for packet filtering and NAT</title><link rel="stylesheet" type="text/css" href="../..//docbook.css" /><meta name="generator" content="DocBook XSL Stylesheets V1.79.1" /><meta name="keywords" content="iptables, ufw, shorewall" /><meta name="keywords" content="&#10;bash,bunzip2,busybox,bzcat,bzcmp,bzdiff,bzegrep,bzexe,bzfgrep,bzgrep,bzip2,bzip2recover,bzless,bzmore,cat,chgrp,chmod,chown,chvt,cp,cpio,dash,date,dbus-cleanup-sockets,dbus-daemon,dbus-uuidgen,dd,df,dir,dmesg,dnsdomainname,domainname,dumpkeys,echo,ed,egrep,false,fgconsole,fgrep,fuser,fusermount,grep,gunzip,gzexe,gzip,hostname,ip,kbd_mode,kill,less,lessecho,lessfile,lesskey,lesspipe,ln,loadkeys,login,ls,lsmod,mkdir,mknod,mktemp,more,mount,mountpoint,mt,mt-gnu,mv,nano,nc,nc.openbsd,netcat,netstat,nisdomainname,ntfs-3g,ntfs-3g.probe,ntfs-3g.secaudit,ntfs-3g.usermap,open,openvt,pidof,ping,ping6,plymouth,ps,pwd,rbash,readlink,rm,rmdir,rnano,run-parts,sed,setfont,setupcon,sh,sh.distrib,sleep,static-sh,stty,su,sync,tailf,tar,tempfile,touch,true,ulockmgr_server,umount,uname,uncompress,unicode_start,vdir,which,ypdomainname,zcat,zcmp,zdiff,zegrep,zfgrep,zforce,zgrep,zless,zmore,znew,,/sbin/:,acpi_available,apm_available,apparmor_parser,badblocks,blkid,blockdev,bootlogd,cfdisk,crda,ctrlaltdel,debugfs,depmod,dhclient,dhclient3,dhclient-script,dmsetup,dosfsck,dosfslabel,dump,dumpe2fs,e2fsck,e2image,e2label,e2undo,ethtool,fdisk,findfs,fsck,fsck.cramfs,fsck.ext2,fsck.ext3,fsck.ext4,fsck.ext4dev,fsck.minix,fsck.msdos,fsck.nfs,fsck.vfat,fstab-decode,getty,halt,hdparm,hwclock,ifconfig,ifdown,ifquery,ifup,init,initctl,insmod,insserv,installkernel,ip,ip6tables,ip6tables-restore,ip6tables-save,ipmaddr,iptables,iptables-restore,iptables-save,iptunnel,isosize,iwconfig,iwevent,iwgetid,iwlist,iwpriv,iwspy,kbdrate,killall5,ldconfig,ldconfig.real,logsave,losetup,lsmod,MAKEDEV,mii-tool,mkdosfs,mke2fs,mkfs,mkfs.bfs,mkfs.cramfs,mkfs.ext2,mkfs.ext3,mkfs.ext4,mkfs.ext4dev,mkfs.minix,mkfs.msdos,mkfs.vfat,mkhomedir_helper,mkswap,modinfo,modprobe,mountall,mount.fuse,mount.nfs,mount.nfs4,mount.ntfs,mount.ntfs-3g,nameif,on_ac_power,pam_tally,parted,partprobe,pivot_root,plipconfig,plymouthd,pmap_dump,pmap_set,portmap,poweroff,rarp,raw,rdump,reboot,regdbdump,reload,resize2fs,restart,restore,rfkill,rmmod,route,rpc.statd,rrestore,rtacct,rtmon,runlevel,sfdisk,shadowconfig,showmount,shutdown,slattach,sm-notify,ss,start,startpar,start-stop-daemon,status,stop,sulogin,swapoff,swapon,switch_root,sysctl,tc,telinit,tune2fs,udevadm,udevd,umount.nfs,umount.nfs4,unix_chkpwd,unix_update,upstart-udev-bridge,ureadahead,wipefs,wpa_action,wpa_cli,wpa_supplicant&#10;&#9;&#9;&#9;, &#10;a2p,acyclic,addftinfo,addpart,afmtodit,animate,anytopnm,apg,apgbfm,apport-bug,apport-cli,apport-collect,apport-unpack,apropos,apt-cache,apt-cdrom,apt-config,apt-extracttemplates,apt-ftparchive,apt-get,aptitude,aptitude-create-state-bundle,aptitude-run-state-bundle,apt-key,apt-mark,apt-sortpkgs,arch,arping,asciitopgm,at,atktopbm,atq,atrm,awk,base64,basename,bashbug,batch,bc,bcomps,bconsole,bdftopcf,bdftops,bdftruncate,bioradtopgm,bmptopnm,bmptoppm,brushtopbm,bsd-mailx,bsd-write,byobu,byobu-config,byobu-export,byobu-janitor,byobu-launch,byobu-launcher,byobu-launcher-install,byobu-launcher-uninstall,byobu-reconnect-sockets,byobu-select-profile,byobu-select-session,byobu-status,byobu-status-detail,c2ph,cal,calendar,captoinfo,catchsegv,catman,cautious-launcher,ccomps,chage,chattr,chcon,check-bios-nx,check-language-support,chem,chfn,chkdupexe,chrt,chsh,circo,ckbcomp,ck-history,ck-launch-session,ck-list-sessions,cksum,clear,clear_console,cmp,cmuwmtopbm,codepage,col,colcrt,colrm,column,comm,compare,compose,composite,config_data,conjure,convert,corelist,cpan,cpan2dist,cpanp,cpanp-run-perl,cpp,cpp-4.4,createrepo,c_rehash,crontab,csplit,ctstat,curl,curlftpfs,cut,dbilogstrip,dbiprof,dbiproxy,dbmmanage,dbus-monitor,dbus-send,ddate,deallocvt,debconf,debconf-apt-progress,debconf-communicate,debconf-copydb,debconf-escape,debconf-set-selections,debconf-show,defoma,defoma-app,defoma-font,defoma-hints,defoma-id,defoma-psfont-installer,defoma-subst,defoma-user,delpart,dh_bash-completion,dh_installdefoma,dh_installxmlcatalogs,dh_pycentral,dh_pysupport,dialog,diff,diff3,diffimg,dig,dijkstra,dircolors,dirname,display,do-release-upgrade,dot,dot2gxl,dotlockfile,dotty,dpkg,dpkg-deb,dpkg-divert,dpkg-query,dpkg-split,dpkg-statoverride,dpkg-trigger,dprofpp,du,dumphint,dumpkeys,dvipdf,easy_install,easy_install-2.6,edit,editor,eject,enc2xs,encode_keychange,env,envsubst,eps2eps,epsffit,eqn,eqn2graph,ex,expand,expiry,expr,extractres,eyuvtoppm,factor,faillog,fallocate,fc-cache,fc-cat,fc-list,fc-match,fc-query,fc-scan,fdp,fiascotopnm,file,find,find2perl,findsmb,fitstopnm,fixdlsrps,fixfmps,fixmacps,fixproc,fixpsditps,fixpspps,fixscribeps,fixtpps,fixwfwps,fixwpps,fixwwps,flock,flow-capture,flow-cat,flow-dscan,flow-expire,flow-export,flow-fanout,flow-filter,flow-gen,flow-header,flow-import,flow-log2rrd,flow-mask,flow-merge,flow-nfilter,flow-print,flow-receive,flow-report,flow-rpt2rrd,flow-rptfmt,flow-send,flow-split,flow-stat,flow-tag,flow-xlate,fmt,fold,font2c,fontconfig-voodoo,fonttosfnt,fping,fping6,free,fribidi,from,fstopgm,ftp,funzip,g3topbm,gawk,gc,gdiffmk,gdk-pixbuf-query-loaders,gemtopbm,gemtopnm,gendiff,geqn,GET,getafm,getconf,getent,getkeycodes,getopt,gettext,gettext.sh,ghostscript,giftopnm,ginstall-info,gio-querymodules,git,git-receive-pack,git-shell,git-upload-archive,git-upload-pack,gmetric,gnokii,gnuplot,gnuplot-nox,gouldtoppm,gpasswd,gpg,gpgsplit,gpgv,gpg-zip,gpic,grap2graph,grn,grodvi,groff,groffer,grog,grolbp,grolj4,grops,grotty,groups,grub-bin2h,grub-editenv,grub-fstest,grub-mkelfimage,grub-mkfont,grub-mkimage,grub-mkisofs,grub-mkpasswd-pbkdf2,grub-mkrelpath,grub-mkrescue,grub-script-check,gs,gsbj,gsdj,gsdj500,gslj,gslp,gsnd,gstat,gtbl,gtk-query-immodules-2.0,gtk-update-icon-cache,gvcolor,gvimtutor,gvpack,gvpr,gxditview,gxl2dot,h2ph,h2xs,hd,head,HEAD,helpztags,hexdump,hipstopgm,host,hostid,hpftodit,htdbm,htdigest,htpasswd,i386,icontopbm,iconv,id,identify,igawk,ilbmtoppm,imgtoppm,import,includeres,indexer,indxbib,info,infobrowser,infocmp,infokey,infotocap,innochecksum,innotop,install,install-info,instmodsh,ionice,iostat,ipcmk,ipcrm,ipcs,ipmicmd,ipmilan,ipmish,ipmitool,ipmi_ui,iptables-xml,join,jpegtopnm,killall,kvm-ok,l4p-tmpl,landscape-sysinfo,last,lastb,lastlog,lcf,ldd,leaftoppm,lefty,less,lessecho,lessfile,lesskey,lesspipe,lexgrog,libnetcfg,line,link,linux32,linux64,linux-boot-prober,lispmtopgm,lkbib,lneato,lnstat,loadkeys,loadunimap,locale,localedef,locate,lockfile-check,lockfile-create,lockfile-remove,lockfile-touch,logger,logname,look,lookbib,lorder,lsattr,lsb_release,lscpu,lshw,lsof,lspci,lspgpot,lsusb,ltrace,lwp-download,lwp-dump,lwp-mirror,lwp-request,lwp-rget,lzcat,lzma,macptopbm,mail,Mail,mail-lock,mailq,mail-touchlock,mail-unlock,mailx,make,make-memtest86+-boot-floppy,make_method,man,mandb,manhole,manpath,mapscrn,mawk,mcookie,md5sum,md5sum.textutils,mdatopbm,memcached,mesg,mgrtopbm,mkfifo,mkfontdir,mkfontscale,mk_modmap,mktap,mlocate,mmroff,modifyrepo,mogrify,montage,motd+shell,mpstat,msql2mysql,mtr,mtvtoppm,munin-check,munin-cron,munindoc,mutt,mutt_dotlock,myisamchk,myisam_ftdump,myisamlog,myisampack,my_print_defaults,mysql,mysqlaccess,mysqladmin,mysqlanalyze,mysqlbinlog,mysqlbug,mysqlcheck,mysql_client_test,mysql_client_test_embedded,mysql_convert_table_format,mysqld_multi,mysqld_safe,mysqldump,mysqldumpslow,mysql_find_rows,mysql_fix_extensions,mysql_fix_privilege_tables,mysqlhotcopy,mysqlimport,mysql_install_db,mysqloptimize,mysqlrepair,mysqlreport,mysql_secure_installation,mysql_setpermission,mysqlshow,mysqlslap,mysqltest,mysqltest_embedded,mysql_tzinfo_to_sql,mysql_upgrade,mysql_waitpid,mysql_zap,mytop,namei,nano,nawk,ncal,ncat,ncftp,ncftp3,ncftpbatch,ncftpbookmarks,ncftpget,ncftpls,ncftpput,ncftpspooler,ncurses5-config,ncursesw5-config,ndiff,neato,neotoppm,neqn,net,netkit-ftp,net.samba3,net-snmp-config,netstat-nat,newaliases,newgrp,ngettext,nice,nl,nmap,nmblookup,nmblookup.samba3,nmon,nohup,nop,nroff,nslookup,nstat,nsupdate,od,oldfind,omshell,on_ac_power,openipmicmd,openipmish,openssl,openssl-vulnkey,os-prober,pager,palmtopnm,pamcut,pamdeinterlace,pamdice,pamfile,pamoil,pamstack,pamstretch,pamstretch-gen,paperconf,parsechangelog,partx,passwd,paste,patch,pathchk,pbmclean,pbmlife,pbmmake,pbmmask,pbmpage,pbmpscale,pbmreduce,pbmtext,pbmtextps,pbmto10x,pbmtoascii,pbmtoatk,pbmtobbnbg,pbmtocmuwm,pbmtoepsi,pbmtoepson,pbmtog3,pbmtogem,pbmtogo,pbmtoicon,pbmtolj,pbmtomacp,pbmtomda,pbmtomgr,pbmtonokia,pbmtopgm,pbmtopi3,pbmtoplot,pbmtoppa,pbmtopsg3,pbmtoptx,pbmtowbmp,pbmtox10bm,pbmtoxbm,pbmtoybm,pbmtozinc,pbmupc,pcimodules,pcretest,pcxtoppm,pdb,pdb2.6,pdb3,pdb3.1,pdf2dsc,pdf2ps,pdfopt,pdfroff,pear,peardev,pecl,peekfd,perl,perl5.10.1,perlbug,perldoc,perlivp,perlthanks,perror,pf2afm,pfbtopfa,pfbtops,pfc,pftp,pg,pgawk,pgmbentley,pgmcrater,pgmedge,pgmenhance,pgmhist,pgmkernel,pgmnoise,pgmnorm,pgmoil,pgmramp,pgmslice,pgmtexture,pgmtofs,pgmtolispm,pgmtopbm,pgmtoppm,pgrep,php,php5,pi1toppm,pi3topbm,pic,pic2graph,pico,piconv,pidstat,pinky,pip,pjtoppm,pkill,pl2pm,plog,pmap,pngtopnm,pnmalias,pnmarith,pnmcat,pnmcolormap,pnmcomp,pnmconvol,pnmcrop,pnmcut,pnmdepth,pnmenlarge,pnmfile,pnmflip,pnmgamma,pnmhisteq,pnmhistmap,pnmindex,pnminterp,pnminterp-gen,pnminvert,pnmmargin,pnmmontage,pnmnlfilt,pnmnoraw,pnmnorm,pnmpad,pnmpaste,pnmpsnr,pnmquant,pnmremap,pnmrotate,pnmscale,pnmscalefixed,pnmshear,pnmsmooth,pnmsplit,pnmtile,pnmtoddif,pnmtofiasco,pnmtofits,pnmtojpeg,pnmtopalm,pnmtoplainpnm,pnmtopng,pnmtops,pnmtorast,pnmtorle,pnmtosgi,pnmtosir,pnmtotiff,pnmtotiffcmyk,pnmtoxwd,pod2html,pod2latex,pod2man,pod2text,pod2usage,podchecker,podselect,poff,pon,POST,post-grohtml,ppm3d,ppmbrighten,ppmchange,ppmcie,ppmcolormask,ppmcolors,ppmdim,ppmdist,ppmdither,ppmfade,ppmflash,ppmforge,ppmhist,ppmlabel,ppmmake,ppmmix,ppmnorm,ppmntsc,ppmpat,ppmquant,ppmquantall,ppmqvga,ppmrainbow,ppmrelief,ppmshadow,ppmshift,ppmspread,ppmtoacad,ppmtobmp,ppmtoeyuv,ppmtogif,ppmtoicr,ppmtoilbm,ppmtojpeg,ppmtoleaf,ppmtolj,ppmtomap,ppmtomitsu,ppmtompeg,ppmtoneo,ppmtopcx,ppmtopgm,ppmtopi1,ppmtopict,ppmtopj,ppmtopuzz,ppmtorgb3,ppmtosixel,ppmtotga,ppmtouil,ppmtowinicon,ppmtoxpm,ppmtoyuv,ppmtoyuvsplit,ppmtv,pr,preconv,pre-grohtml,prename,print,printafm,printenv,printerbanner,printf,prove,prtstat,prune,ps2ascii,ps2epsi,ps2pdf,ps2pdf12,ps2pdf13,ps2pdf14,ps2pdfwr,ps2ps,ps2ps2,ps2txt,psbook,psed,psfaddtable,psfgettable,psfstriptable,psfxtable,psidtopgm,psmerge,psnup,psresize,psselect,pstopnm,pstops,pstree,pstree.x11,pstruct,ptar,ptardiff,ptx,pwdx,py3_compilefiles,pycentral,pyclean,pycompile,py_compilefiles,pydoc,pydoc2.6,pydoc3,pydoc3.1,pygettext,pygettext2.6,pygettext3,pygettext3.1,pyhtmlizer,python,python2,python2.6,python3,python3.1,pyversions,qrttoppm,rasttopnm,rawtopgm,rawtoppm,rcp,red,refer,rename,rename.ul,renice,replace,report-hw,reset,resolveip,resolve_stack_dump,rev,rgb3toppm,rgrep,rletopnm,rlogin,rmcp_ping,roff2dvi,roff2html,roff2pdf,roff2ps,roff2text,roff2x,routef,routel,rpcclient,rpcinfo,rpm,rpm2cpio,rpmbuild,rpmdb,rpmgraph,rpmquery,rpmsign,rpmverify,rrdcgi,rrdtool,rrdupdate,rsh,rsync,rtstat,runcon,run-mailcap,rview,rvim,s2p,sadf,sar,sar.sysstat,savelog,sbigtopgm,sccmap,scp,screen,screendump,screen-launcher,screen-profiles-status,script,scriptreplay,sdiff,search,searchd,see,select-editor,sendsms,sensible-browser,sensible-editor,sensible-pager,sensors,sensors-conf-convert,seq,service,setarch,setkeycodes,setleds,setlogcons,setmetamode,setpci,setsid,setterm,sftp,sg,sgitopnm,sha1sum,sha224sum,sha256sum,sha384sum,sha512sum,shasum,showchar,showconsolefont,showkey,shred,shuf,sirtopnm,skill,slabtop,sldtoppm,slogin,smbcacls,smbclient,smbcquotas,smbget,smbpasswd,smbspool,smbtar,smbtree,smime_keys,snice,snmpbulkget,snmpbulkwalk,snmpconf,snmpdelta,snmpdf,snmpget,snmpgetnext,snmpinform,snmpkey,snmpnetstat,snmpset,snmpstatus,snmptable,snmptest,snmptranslate,snmptrap,snmpusm,snmpvacm,snmpwalk,soelim,solterm,sort,spctoppm,spelldump,splain,split,splitfont,sputoppm,ssh,ssh-add,ssh-agent,ssh-argv0,ssh-copy-id,sshfs,ssh-keygen,ssh-keyscan,ssh-vulnkey,st4topgm,stat,strace,stream,sudo,sudoedit,sum,svn,svnadmin,svnauthz-validate,svndumpfilter,svnlook,svnmucc,svn-populate-node-origins-index,svnserve,svnsync,svnversion,tabs,tac,tail,tap2deb,tap2rpm,tapconvert,tasksel,taskset,tbl,tee,telnet,telnet.netkit,test,testparm,testparm.samba3,tfmtodit,tgatoppm,thinkjettopbm,tic,tifftopnm,time,tload,toe,top,touch,tput,tr,tracepath,tracepath6,traceroute6,traceroute6.iputils,traptoemail,tred,trial,troff,truncate,tset,tsort,tty,twistd,twopi,tzselect,ubuntu-bug,ubuntu-support-status,ucf,ucfq,ucfr,ucs2any,ul,unattended-upgrade,unattended-upgrades,unexpand,unflatten,unicode_stop,uniq,unlink,unlzma,unshare,unzip,unzipsfx,update-alternatives,updatedb,updatedb.mlocate,update-mime-database,update-mime-database.real,update-pciids,update-perl-sax-parsers,uptime,usb-devices,users,uuidgen,vi,view,vim,vim.basic,vimdiff,vim.tiny,vimtutor,vmstat,volname,w,w3m,w3mman,wall,watch,wbmptopbm,wc,webalizer,webazolver,wftopfa,wget,whatis,whereis,which,whiptail,who,whoami,winicontoppm,wpa_passphrase,w.procps,write,www-browser,X11,x86_64,x86_64-linux-gnu-cpp,x86_64-linux-gnu-cpp-4.4,xargs,xauth,xbmtopbm,ximtoppm,xpmtoppm,xsubpp,xtotroff,xvminitoppm,xwdtopnm,xxd,ybmtopbm,yes,yuvsplittoppm,yuvtoppm,zabbix_get,zdump,zeisstopnm,zipgrep,zipinfo,zsoelim,,/usr/sbin/:,a2dismod,a2dissite,a2enmod,a2ensite,aa-audit,aa-autodep,aa-complain,aa-decode,aa-enforce,aa-genprof,aa-logprof,aa-status,aa-unconfined,ab,accessdb,addgroup,add-shell,adduser,apache2,apache2ctl,apparmor_status,arp,arpd,atd,audit,autodep,bacula-console,bacula-fd,bandwidthd,bcrelay,biosdecode,brctl,bsmtp,btraceback,chat,check_forensic,checkgid,chgpasswd,chpasswd,chroot,ck-log-system-restart,ck-log-system-start,ck-log-system-stop,complain,console-kit-daemon,cpgr,cppw,cron,cytune,dbconfig-generate-include,dbconfig-load-include,defoma-reconfigure,delgroup,deluser,dmidecode,dpkg-divert,dpkg-preconfigure,dpkg-reconfigure,dpkg-statoverride,e2freefrag,enforce,ethtool,exicyclog,exigrep,exim,exim4,exim_checkaccess,exim_convert4r4,exim_dbmbuild,exim_dumpdb,exim_fixdb,exim_lock,eximstats,exim_tidydb,exinext,exipick,exiqgrep,exiqsumm,exiwhat,fancontrol,fdformat,filefrag,genprof,gmetad,gmond,gnokiid,groupadd,groupdel,groupmod,grpck,grpconv,grpunconv,grub-install,grub-mkconfig,grub-mkdevicemap,grub-probe,grub-reboot,grub-set-default,grub-setup,gss_clnt_send_err,gss_destroy_creds,htcacheclean,httxt2dbm,iconvconfig,install-info,install-sgmlcatalog,invoke-rc.d,ip6tables-apply,ipmievd,iptables-apply,irqbalance,isadump,isaset,laptop-detect,ldattach,libgraphviz4-config-update,locale-gen,login.radius,logprof,logresolve,logrotate,lsusb,make-ssl-cert,mgnokiidev,mkinitramfs,mkinitramfs-kpkg,mklost+found,munin-node,munin-node-configure,munin-run,mysqld,mysqlmanager,nagios3,nagios3stats,newusers,nfsstat,nologin,ntop,ntpd,ntpdate,ntpdate-debian,openntpd,openvpn,openvpn-vulnkey,ownership,pam-auth-update,pam_getenv,paperconfig,popcon-largest-unused,popularity-contest,pppconfig,pppd,pppdump,pppoeconf,pppoe-discovery,pppstats,pptpctrl,pptpd,pwck,pwconv,pwmconfig,pwunconv,radacct,radexample,radlogin,radstatus,ramsize,rdev,readprofile,remove-shell,rmail,rmt,rmt-dump,rmt-tar,rootflags,rotatelogs,rpcdebug,rpc.gssd,rpc.idmapd,rsmtp,rsyslogd,rtcwake,runq,safe_finger,sendmail,sensors-detect,service,setvesablank,snmpd,snmptrapd,spine,split-logfile,sshd,syslog2eximlog,tcpd,tcpdchk,tcpdmatch,tcpdump,try-from,tunelp,tzconfig,ufw,unconfined,update-alternatives,update-bootsystem-insserv,update-ca-certificates,update-catalog,update-exim4.conf,update-exim4.conf.template,update-exim4defaults,update-fonts-alias,update-fonts-dir,update-fonts-scale,update-gdkpixbuf-loaders,update-grub,update-grub2,update-gtk-immodules,update-icon-caches,update-inetd,update-info-dir,update-initramfs,update-locale,update-mime,update-pangox-aliases,update-passwd,update-python-modules,update-rc.d,update-rc.d-insserv,update-usbids,update-xmlcatalog,upgrade-from-grub-legacy,useradd,userdel,usermod,uuidd,validlocale,vcstime,vidmode,vigr,vipw,visudo,vpddecode,vsftpd,xl2tpd,zabbix_server,zic&#10;&#9;&#9;&#9;, CentOS, Piranha, NFS, &#10;arch,awk,basename,bash,cat,cgclassify,cgcreate,cgdelete,cgexec,cgget,cgset,chgrp,chmod,chown,cp,cpio,cut,dash,date,dd,df,dmesg,dnsdomainname,domainname,dumpkeys,echo,egrep,env,ex,false,fgrep,find,gawk,grep,gtar,gunzip,gzip,hostname,ipcalc,iptables-xml,kbd_mode,kill,link,ln,loadkeys,login,ls,lscgroup,lssubsys,mkdir,mknod,mktemp,more,mount,mountpoint,mv,mybash,netstat,nice,nisdomainname,ping,ping6,plymouth,ps,pwd,raw,readlink,rm,rmdir,rpm,rvi,rview,sed,setfont,sh,shell.sh,sleep,sort,stty,su,sync,tar,taskset,touch,tracepath,tracepath6,true,umount,uname,unicode_start,unicode_stop,unlink,usleep,vi,view,ypdomainname,zcat,,/sbin/:,addpart,agetty,arp,arping,audispd,auditctl,auditd,aureport,ausearch,autrace,badblocks,blkid,blockdev,cbq,cfdisk,cgclear,cgconfigparser,cgrulesengd,chkconfig,clock,consoletype,crda,ctrlaltdel,debugfs,delpart,depmod,dracut,dumpe2fs,e2fsck,e2image,e2label,e2undo,ether-wake,ethtool,fdisk,findfs,fixfiles,fsck,fsck.cramfs,fsck.ext2,fsck.ext3,fsck.ext4,fsck.ext4dev,fsfreeze,fstab-decode,fuser,genhostid,getkey,grub,grubby,grub-install,grub-md5-crypt,grub-terminfo,halt,hwclock,ifcfg,ifconfig,ifdown,ifenslave,ifrename,ifup,init,initctl,insmod,insmod.static,install-info,installkernel,ip,ip6tables,ip6tables-multi,ip6tables-restore,ip6tables-save,ipmaddr,iptables,iptables-multi,iptables-restore,iptables-save,iptunnel,iw,iwconfig,iwevent,iwgetid,iwlist,iwpriv,iwspy,killall5,ldconfig,load_policy,logsave,losetup,lsinitrd,lsmod,lspci,MAKEDEV,matchpathcon,mii-diag,mii-tool,mingetty,mke2fs,mkfs,mkfs.cramfs,mkfs.ext2,mkfs.ext3,mkfs.ext4,mkfs.ext4dev,mkhomedir_helper,mkinitrd,mkswap,modinfo,modprobe,mount.nfs,mount.nfs4,mount.tmpfs,nameif,netreport,new-kernel-pkg,nologin,pam_console_apply,pam_tally2,pam_timestamp_check,partx,pidof,pivot_root,plipconfig,plymouthd,poweroff,ppp-watch,rdisc,reboot,regdbdump,reload,resize2fs,restart,restorecon,rmmod,route,rpcbind,rpc.statd,rsyslogd,rtmon,runlevel,runuser,scsi_id,securetty,service,setfiles,setpci,setregdomain,setsysfont,sfdisk,shutdown,slattach,sln,start,start_udev,status,stop,sulogin,sushell,swapoff,swapon,switch_root,sysctl,tc,telinit,tune2fs,udevadm,udevd,umount.nfs,umount.nfs4,unix_chkpwd,unix_update,weak-modules,wipefs&#10;&#9;&#9;&#9;, &#10;a2p,ab,aclocal,aclocal-1.11,addftinfo,addr2line,airdaemon,apropos,ar,as,attr,aulast,aulastlog,ausyscall,autoconf,autoheader,autom4te,automake,automake-1.11,autoreconf,autoscan,autoupdate,awk,base64,bashbug-64,berkeley_db_svc,bunzip2,bzcat,bzcmp,bzdiff,bzgrep,bzip2,bzip2recover,bzless,bzmore,c++,c2ph,c89,c99,cal,captoinfo,catchsegv,cc,c++filt,chacl,chage,chattr,chcon,checkmodule,checkpolicy,chfn,chrt,chsh,chvt,cjpeg,cksum,clear,cloog,cmp,col,colcrt,colrm,column,comm,consolehelper,convertcfg,cpp,crontab,csplit,curl,curl-config,cut,cxpm,db_archive,db_checkpoint,db_codegen,db_deadlock,db_dump,db_dump185,db_hotbackup,db_load,db_printlog,db_recover,db_stat,db_upgrade,dbus-binding-tool,db_verify,ddate,deallocvt,diff,diff3,dir,dircolors,dirname,djpeg,dprofpp,du,env,eqn,eqn2graph,erb,ex,expand,expr,factor,faillog,fallocate,fc-cache,fc-cat,fc-list,fc-match,fc-query,fc-scan,fgconsole,file,filedaemon,find,find2perl,fipscheck,fipshmac,flock,floppy,fmt,fold,free,freetype-config,funzip,g++,gawk,gcc,gcov,gdlib-config,gem,gencat,geqn,getconf,getent,getfacl,getfattr,getkeycodes,getopt,gindxbib,glookbib,gmake,gneqn,gnroff,gpasswd,gpg,gpg2,gpg-agent,gpgconf,gpg-connect-agent,gpg-error,gpgkey2ssh,gpgparsemail,gpgsplit,gpgv,gpgv2,gpg-zip,gpic,gprof,grefer,grn,grodvi,groff,groffer,grog,grolbp,grolj4,grops,grotty,groups,gsoelim,gtbl,gtroff,gunzip,gzexe,gzip,h2ph,halt,head,hexdump,hostid,hpftodit,htdbm,htdigest,htpasswd,i386,iconv,id,idn,ifnames,igawk,indxbib,info,infocmp,infokey,infotocap,install,ionice,ipcmk,ipcrm,ipcs,ipmicmd,ipmilan,ipmish,ipmitool,ipmi_ui,irb,isosize,join,jpegtran,kbdrate,kill,killall,last,lastb,lastlog,lchfn,lchsh,ld,ldd,less,lessecho,lesskey,lesspipe.sh,libpng12-config,libpng-config,linux32,linux64,lkbib,loadunimap,locale,localedef,logger,logname,logresolve,look,lookbib,lsattr,lscpu,lua,luac,lzcat,lzcmp,lzdiff,lzegrep,lzfgrep,lzgrep,lzless,lzma,lzmadec,lzmainfo,lzmore,m4,mailq,mailq.postfix,make,man,man2html,manpath,mapscrn,mbchk,mcookie,md5sum,mesg,mini_epn,mkfifo,nagios,nagiostats,namei,neqn,net-snmp-create-v3-user,newaliases,newaliases.postfix,newgrp,new_mini_epn,nl,nm,nohup,nproc,nroff,ntpstat,objcopy,objdump,od,oldfind,open,openipmicmd,openipmish,openssl,openvt,p1.pl,passwd,paste,pathchk,pcregrep,pcretest,peekfd,perl,perl5.10.1,perlbug,perldoc,perlthanks,pfbtops,pgawk,pgrep,phar,phar.phar,php,php-cgi,pic,pic2graph,piconv,pinentry,pinentry-curses,pinky,pkg-config,pkill,pl2pm,plymouth,pmap,pod2html,pod2latex,pod2man,pod2text,pod2usage,podchecker,podselect,post-grohtml,poweroff,ppl-config,pr,pre-grohtml,printenv,printf,protoize,psed,psfaddtable,psfgettable,psfstriptable,psfxtable,pstree,pstree.x11,pstruct,ptx,pwdx,pydoc,python,python2,python2.6,ranlib,rb,rdjpgcom,rdoc,readelf,readlink,reboot,refer,rename,renice,reset,resizecons,rev,rhgb-client,ri,rmail,rmail.postfix,rmcp_ping,rpcgen,rpm2cpio,rpmdb,rpmquery,rpmsign,rpmverify,rsync,ruby,runcon,run-parts,rvim,rx,rz,s2p,sb,scp,script,scriptreplay,sdiff,secon,sedismod,sedispol,semodule_deps,semodule_expand,semodule_link,semodule_package,seq,sequel,setarch,setfacl,setfattr,setkeycodes,setleds,setmetamode,setsid,setterm,setup-nsssysinit.sh,sftp,sg,sha1sum,sha224sum,sha256sum,sha384sum,sha512sum,showconsolefont,showkey,shred,shuf,size,skill,slabtop,slogin,snice,snmpconf,snmpkey,soelim,solterm,splain,split,sprof,sqlite3,ssh,ssh-add,ssh-agent,ssh-copy-id,ssh-keygen,ssh-keyscan,stat,stdbuf,strings,strip,sudo,sudoedit,sum,sx,sxpm,system-config-network,system-config-network-cmd,sz,tabs,tac,tail,tailf,tbl,tee,telnet,test,testrb,tfmtodit,tic,time,timeout,tload,toe,top,tput,tr,troff,truncate,tset,tsort,tty,tzselect,ul,unexpand,uniq,unlzma,unprotoize,unshare,unxz,unzip,unzipsfx,uptime,urlgrabber,users,utmpdump,uuidgen,vdir,vim,vimdiff,vimtutor,vmstat,w,wall,watch,watchgnupg,wc,wget,whatis,whereis,which,whiptail,who,whoami,write,wrjpgcom,x86_64,x86_64-redhat-linux-c++,x86_64-redhat-linux-g++,x86_64-redhat-linux-gcc,xargs,xml2-config,xmlcatalog,xmllint,xmlwf,xxd,xz,xzcat,xzcmp,xzdec,xzdiff,xzegrep,xzfgrep,xzgrep,xzless,xzmore,yaf,yafcollect,yafscii,yes,yum,zcmp,zdiff,zegrep,zfgrep,zforce,zgrep,zip,zipcloak,zipgrep,zipinfo,zipnote,zipsplit,zless,zmore,znew,zsoelim,,/usr/sbin/:,addgnupghome,adduser,alternatives,anacron,apachectl,applygnupgdefaults,arpd,arping,authconfig,authconfig-tui,avcstat,build-locale-archive,cacertdir_rehash,capsh,chpasswd,chroot,clockdiff,cracklib-check,cracklib-format,cracklib-packer,cracklib-unpacker,create-cracklib-dict,crond,e2freefrag,efibootmgr,ethtool,exportfs,fdformat,filefrag,fping,fping6,genhomedircon,getcap,getenforce,getpcaps,getsebool,glibc_post_upgrade.x86_64,groupadd,groupdel,groupmems,groupmod,grpck,grpconv,grpunconv,gss_clnt_send_err,gss_destroy_creds,htcacheclean,httpd,httpd.event,httpd.worker,httxt2dbm,hwclock,iconvconfig,iconvconfig.x86_64,ipmievd,lchage,ldattach,lgroupadd,lgroupdel,lgroupmod,libgcc_post_upgrade,lid,lnewusers,lnstat,load_policy,logrotate,lokkit,lpasswd,lsof,luseradd,luserdel,lusermod,makewhatis,matchpathcon,mkdict,mklost+found,mksock,mountstats,newusers,nfsiostat,nfsstat,nrpe,nstat,ntpd,ntpdate,ntpdc,ntp-keygen,ntpq,ntptime,open_init_pty,packer,pethtool,pifconfig,ping6,pluginviewer,plymouth-set-default-theme,postalias,postcat,postconf,postdrop,postfix,postkick,postlock,postlog,postmap,postmulti,postqueue,postsuper,pwck,pwconv,pwunconv,readprofile,restorecond,rotatelogs,rpcdebug,rpc.gssd,rpc.idmapd,rpcinfo,rpc.mountd,rpc.nfsd,rpc.svcgssd,rtacct,rtcwake,run_init,saslauthd,sasldblistusers2,saslpasswd2,selinuxconlist,selinuxdefcon,selinuxenabled,semodule,sendmail,sendmail.postfix,sestatus,setcap,setenforce,setsebool,showmount,sm-notify,smtp-sink,smtp-source,snmpd,snmptrapd,ss,sshd,start-statd,suexec,system-config-network,system-config-network-cmd,system-config-network-tui,sys-unconfig,tcpdump,tcpslice,testsaslauthd,tickadj,togglesebool,tracepath,tracepath6,tunelp,tzdata-update,update-alternatives,update-pciids,useradd,userdel,userhelper,usermod,usernetctl,vigr,vipw,visudo,zdump,zic&#10;&#9;&#9;&#9;" /><link rel="home" href="../../index.html" title="Netkiller Linux 手札" /><link rel="up" href="index.html" title="第 41 章 Firewall" /><link rel="prev" href="index.html" title="第 41 章 Firewall" /><link rel="next" href="ulogd.html" title="41.3. ulogd - The Netfilter Userspace Logging Daemon" /></head><body><a xmlns="" href="//www.netkiller.cn/">Home</a> |
		<a xmlns="" href="//netkiller.github.io/">简体中文</a> |
	    <a xmlns="" href="http://netkiller.sourceforge.net/">繁体中文</a> |
	    <a xmlns="" href="/journal/index.html">杂文</a> |
	    <a xmlns="" href="//www.netkiller.cn/home/donations.html">打赏(Donations)</a> |
	    <a xmlns="" href="http://netkiller-github-com.iteye.com/">ITEYE 博客</a> |
	    <a xmlns="" href="http://my.oschina.net/neochen/">OSChina 博客</a> |
	    <a xmlns="" href="https://www.facebook.com/bg7nyt">Facebook</a> |
	    <a xmlns="" href="http://cn.linkedin.com/in/netkiller/">Linkedin</a> |
	    <a xmlns="" href="https://zhuanlan.zhihu.com/netkiller">知乎专栏</a> |
	    <a xmlns="" href="/search.html">Search</a> |
		<a xmlns="" href="mailto:netkiller@msn.com">Email</a><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="3" align="center">41.2. iptables - administration tools for packet filtering and NAT</th></tr><tr><td width="20%" align="left"><a accesskey="p" href="index.html">上一页</a> </td><th width="60%" align="center">第 41 章 Firewall</th><td width="20%" align="right"> <a accesskey="n" href="ulogd.html">下一页</a></td></tr></table><hr /></div><table xmlns=""><tr><td><iframe src="//ghbtns.com/github-btn.html?user=netkiller&amp;repo=netkiller.github.io&amp;type=watch&amp;count=true&amp;size=large" height="30" width="170" frameborder="0" scrolling="0" style="width:170px; height: 30px;" allowTransparency="true"></iframe></td><td><iframe src="//ghbtns.com/github-btn.html?user=netkiller&amp;repo=netkiller.github.io&amp;type=fork&amp;count=true&amp;size=large" height="30" width="170" frameborder="0" scrolling="0" style="width:170px; height: 30px;" allowTransparency="true"></iframe></td><td><iframe src="//ghbtns.com/github-btn.html?user=netkiller&amp;type=follow&amp;count=true&amp;size=large" height="30" width="240" frameborder="0" scrolling="0" style="width:240px; height: 30px;" allowTransparency="true"></iframe></td></tr></table><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="iptables"></a>41.2. iptables - administration tools for packet filtering and NAT</h2></div></div></div>
	
	<p><a class="ulink" href="http://www.netkiller.cn/linux/network/firewall" target="_top">Linux Iptables Manual</a></p>
	<pre class="screen">
	
      Incoming
       Traffic
          |
          |
          V
     +----------+
     |PREROUTING|
     +----------+
     |   raw    |  &lt;--------------+
     |  mangle  |                 |
     |   nat    |                 |
     +----------+                 |
          |                       |
          |                       |
       Routing                    |
    +- Decision -+                |
    |            |                |
    |            |                |
    V            V                |
  Local        Remote             |
Destination   Destination         |
    |            |                |
    |            |                |
    V            V                |
+--------+  +---------+           |
| INPUT  |  | FORWARD |           |
+--------+  +---------+           |
| mangle |  | mangle  |           |
| filter |  | filter  |           |
+--------+  +---------+           |
    |            |                |
    |            |                |
    V            |                |
  Local          |                |
 Machine         |                |
    |            |                |
    |            |                |
    V            |                |
 Routing         |                |
 Decision        |                |
    |            |                |
    |            |                |
    V            |                |
+--------+       |                |
| OUTPUT |       |                |
+--------+       |                |
|  raw   |       |                |
| mangle |       |                |
|  nat   |       |                |
| filter |       |                |
+--------+       |                |
    |            |                |
    |      +-------------+        |
    |      | POSTROUTING |      Local
    +----&gt; +-------------+ --&gt; Traffic
           |   mangle    |
           |     nat     |
           +-------------+
                 |
                 |
                 V
              Outgoing
              Traffic
	
	</pre>
	<div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="start"></a>41.2.1. Getting Started</h3></div></div></div>
		
		<p>Redhat / CentOS</p>
		<p>You can check to see if iptables is installed on your system by:</p>
		<pre class="screen">
[root@database ~]# rpm -q iptables
iptables-1.3.5-5.3.el5_4.1
		</pre>
		<p>And to see if iptables is actually running, we can check that the iptables modules are loaded and use the -L switch to inspect the currently loaded rules:</p>
		<pre class="screen">
[root@database ~]# lsmod | grep ip_tables
ip_tables              55201  2 iptable_nat,iptable_filter
x_tables               50505  6 ipt_MASQUERADE,iptable_nat,xt_state,ipt_REJECT,xt_tcpudp,ip_tables

		</pre>

		<pre class="screen">
[root@database ~]# iptables -L
Chain INPUT (policy ACCEPT)
target     prot opt source               destination
ACCEPT     udp  --  anywhere             anywhere            udp dpt:domain
ACCEPT     tcp  --  anywhere             anywhere            tcp dpt:domain
ACCEPT     udp  --  anywhere             anywhere            udp dpt:bootps
ACCEPT     tcp  --  anywhere             anywhere            tcp dpt:bootps

Chain FORWARD (policy ACCEPT)
target     prot opt source               destination
ACCEPT     all  --  anywhere             192.168.122.0/24    state RELATED,ESTABLISHED
ACCEPT     all  --  192.168.122.0/24     anywhere
ACCEPT     all  --  anywhere             anywhere
REJECT     all  --  anywhere             anywhere            reject-with icmp-port-unreachable
REJECT     all  --  anywhere             anywhere            reject-with icmp-port-unreachable

Chain OUTPUT (policy ACCEPT)
target     prot opt source               destination

		</pre>
		<p>显示行号</p>
		<pre class="screen">
# iptables --list -nv --line-number 
Chain INPUT (policy ACCEPT 0 packets, 0 bytes)
num   pkts bytes target     prot opt in     out     source               destination         
1      139 15916 ACCEPT     all  --  *      *       0.0.0.0/0            0.0.0.0/0            state RELATED,ESTABLISHED
2        1    92 ACCEPT     icmp --  *      *       0.0.0.0/0            0.0.0.0/0           
3        0     0 ACCEPT     all  --  lo     *       0.0.0.0/0            0.0.0.0/0           
4        1    40 ACCEPT     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            state NEW tcp dpt:22
5        0     0 ACCEPT     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            state NEW tcp dpt:80
6        0     0 ACCEPT     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            state NEW tcp dpt:25
7        0     0 ACCEPT     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            state NEW tcp dpt:20
8        2   104 ACCEPT     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            state NEW tcp dpt:21
9        1    40 REJECT     all  --  *      *       0.0.0.0/0            0.0.0.0/0            reject-with icmp-host-prohibited

Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)
num   pkts bytes target     prot opt in     out     source               destination         
1        0     0 REJECT     all  --  *      *       0.0.0.0/0            0.0.0.0/0            reject-with icmp-host-prohibited

Chain OUTPUT (policy ACCEPT 137 packets, 24640 bytes)
num   pkts bytes target     prot opt in     out     source               destination		
		</pre>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idp320"></a>41.2.1.1. CentOS/Redhat TUI 工具</h4></div></div></div>
			
			<p>If iptables is not running, you can enable it by running:</p>
			<pre class="screen">
# lokkit --enabled --selinux=disabled
# lokkit --disabled --selinux=disabled
			</pre>

			<pre class="screen">
# lokkit --enabled

# ls /etc/sysconfig/iptables*
iptables         iptables-config  iptables.old

# cat /etc/sysconfig/iptables
# Firewall configuration written by system-config-firewall
# Manual customization of this file is not recommended.
*filter
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
-A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
-A INPUT -p icmp -j ACCEPT
-A INPUT -i lo -j ACCEPT
-A INPUT -m state --state NEW -m tcp -p tcp --dport 22 -j ACCEPT
-A INPUT -j REJECT --reject-with icmp-host-prohibited
-A FORWARD -j REJECT --reject-with icmp-host-prohibited
COMMIT

# lokkit --disabled
# ls /etc/sysconfig/iptables*
iptables-config  iptables.old
			</pre>
			<p>lokkit --enabled作用就是产生/etc/sysconfig/iptables文件。--disabled的作用是将更名为iptables.old</p>
			<pre class="screen">
# system-config-securitylevel
			</pre>
		</div>
	</div>
	<div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="udc"></a>41.2.2. 用户自定义规则连</h3></div><div><h4 class="subtitle">User-defined Chain</h4></div></div></div>
		
						
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idp321"></a>41.2.2.1. Chains List</h4></div></div></div>
			
			<p>列出规则链</p>
			<pre class="screen">
 列出INPUT,OUTPUT,FORWARD规则
iptables -L

列出NAT规则
iptables -t nat -L

列出过滤规则
iptables -t filter -L
			</pre>
			<p>显示行号</p>
			<pre class="screen">
# iptables -L --line-numbers
Chain INPUT (policy ACCEPT)
num  target     prot opt source               destination
1    ACCEPT     all  --  anywhere             192.168.2.10
2    ACCEPT     all  --  anywhere             192.168.2.11
3    ACCEPT     all  --  anywhere             192.168.2.12
4    ACCEPT     all  --  anywhere             192.168.2.13
5    ACCEPT     all  --  anywhere             192.168.2.14
6    DROP       all  --  anywhere             anywhere

Chain FORWARD (policy ACCEPT)
num  target     prot opt source               destination

Chain OUTPUT (policy ACCEPT)
num  target     prot opt source               destination
			</pre>
			<p>显示包转发</p>
			<pre class="screen">
# iptables -L -v
Chain INPUT (policy ACCEPT 881 packets, 146K bytes)
 pkts bytes target     prot opt in     out     source               destination
    0     0 ACCEPT     all  --  tun0   any     anywhere             192.168.2.10
    0     0 ACCEPT     all  --  tun0   any     anywhere             192.168.2.11
    0     0 ACCEPT     all  --  tun0   any     anywhere             192.168.2.12
    0     0 ACCEPT     all  --  tun0   any     anywhere             192.168.2.13
    0     0 ACCEPT     all  --  tun0   any     anywhere             192.168.2.14
    0     0 DROP       all  --  tun0   any     anywhere             anywhere

Chain FORWARD (policy ACCEPT 1190 packets, 440K bytes)
 pkts bytes target     prot opt in     out     source               destination

Chain OUTPUT (policy ACCEPT 888 packets, 437K bytes)
 pkts bytes target     prot opt in     out     source               destination
			</pre>
			<pre class="screen">
# iptables -L -t nat -v
Chain PREROUTING (policy ACCEPT 509 packets, 43877 bytes)
 pkts bytes target     prot opt in     out     source               destination

Chain POSTROUTING (policy ACCEPT 94 packets, 6038 bytes)
 pkts bytes target     prot opt in     out     source               destination
  163 13140 MASQUERADE  all  --  any    br0     10.8.0.0/24          anywhere

Chain OUTPUT (policy ACCEPT 94 packets, 6038 bytes)
 pkts bytes target     prot opt in     out     source               destination
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idp322"></a>41.2.2.2. Chains Refresh</h4></div></div></div>
			
			<p>刷新规则</p>
			<pre class="screen">
/sbin/iptables -F
/sbin/iptables -F -t filter
/sbin/iptables -F -t nat
/sbin/iptables -t nat -P PREROUTING ACCEPT
/sbin/iptables -t nat -P POSTROUTING ACCEPT
/sbin/iptables -P INPUT ACCEPT
/sbin/iptables -P OUTPUT ACCEPT
/sbin/iptables -P FORWARD ACCEPT
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idp323"></a>41.2.2.3. Chains Admin</h4></div></div></div>
			
			<p>创建新链</p>
			<pre class="screen">
				iptables -N netkiller
			</pre>
			<p>删除新链</p>
			<pre class="screen">
				# iptables -X netkiller
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idp324"></a>41.2.2.4. 重置</h4></div></div></div>
			
			<div class="example"><a id="idp1102"></a><p class="title"><strong>例 41.1. /etc/sysconfig/iptables</strong></p><div class="example-contents">
				
				<pre class="screen">
/sbin/iptables -F
/sbin/iptables -F -t filter
/sbin/iptables -F -t nat
/sbin/iptables -t nat -P PREROUTING ACCEPT
/sbin/iptables -t nat -P POSTROUTING ACCEPT
/sbin/iptables -t nat -P OUTPUT ACCEPT
/sbin/iptables -P INPUT ACCEPT
/sbin/iptables -P OUTPUT ACCEPT
/sbin/iptables -P FORWARD ACCEPT

sysctl net.ipv4.ip_forward=1
				</pre>
				<p>/etc/sysconfig/iptables</p>
				<pre class="screen">
-P INPUT ACCEPT
-P FORWARD ACCEPT
-P OUTPUT ACCEPT
-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
-A INPUT -p icmp -j ACCEPT
-A INPUT -i lo -j ACCEPT
-A INPUT -p tcp -m state --state NEW -m tcp --dport 22 -j ACCEPT
-A INPUT -j REJECT --reject-with icmp-host-prohibited
-A FORWARD -j REJECT --reject-with icmp-host-prohibited				
				</pre>
			</div></div><br class="example-break" />
		</div>
	</div>
	<div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="protocol"></a>41.2.3. Protocols 协议</h3></div></div></div>
		
		<pre class="screen">
-p tcp
-p udp
		</pre>
	</div>
	<div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="interface"></a>41.2.4. Interfaces 网络适配器接口</h3></div></div></div>
		
		<pre class="screen">
iptables -A INPUT -i lo -j ACCEPT
iptables -A INPUT -i eth0 -j ACCEPT
iptables -A INPUT -i ppp0 -j ACCEPT
		</pre>
	</div>
	<div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="source"></a>41.2.5. 源IP地址</h3></div></div></div>
		
		<pre class="screen">
# Accept packets from trusted IP addresses
 iptables -A INPUT -s 192.168.0.4 -j ACCEPT # change the IP address as appropriate

# Accept packets from trusted IP addresses
 iptables -A INPUT -s 192.168.0.0/24 -j ACCEPT  # using standard slash notation
 iptables -A INPUT -s 192.168.0.0/255.255.255.0 -j ACCEPT # using a subnet mask


# Accept packets from trusted IP addresses
 iptables -A INPUT -s 192.168.0.4 -m mac --mac-source 00:50:8D:FD:E6:32 -j ACCEPT
		</pre>
		<p>多地址输入方法</p>
		<pre class="screen">
iptables -t filter -A INPUT -s 192.168.1.1,2.2.2.2,10.10.10.10 -j ACCEPT		
		</pre>
		<p>连续范围</p>
		<pre class="screen">
-A INPUT -i eth0 -m iprange --src-range 192.168.1.90-192.168.1.101 -j ACCEPT		
		</pre>
	</div>
	<div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="port"></a>41.2.6. Ports 端口</h3></div></div></div>
		
		<pre class="screen">
# Accept tcp packets on destination port 6881 (bittorrent)
 iptables -A INPUT -p tcp --dport 6881 -j ACCEPT
		</pre>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idp325"></a>41.2.6.1. range</h4></div></div></div>
			
			<pre class="screen">
# Accept tcp packets on destination ports 6881-6890
iptables -A INPUT -p tcp --dport 6881:6890 -j ACCEPT
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idp326"></a>41.2.6.2. multiport</h4></div></div></div>
			
			<p>多端口</p>
			<pre class="screen">
-A INPUT -s 116.24.13.13/32 -p tcp -m tcp -m multiport --dports 21,20 -j ACCEPT
			</pre>
		</div>
	</div>

	<div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="nat"></a>41.2.7. NAT</h3></div></div></div>
		
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idp327"></a>41.2.7.1. Redirect</h4></div></div></div>
			
			<p>重定向规则</p>
			<pre class="screen">
端口重定向
# iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 21 -j REDIRECT --to-port 2401

将80端口重定向到8080
# iptables -t nat -A PREROUTING -j REDIRECT -p tcp --destination-port 80 --to-ports 8080
			</pre>
			<p>端口转发</p>
			<pre class="screen">
echo 1 &gt; /proc/sys/net/ipv4/ip_forward
iptables -t nat -A PREROUTING -d 192.168.3.9 -p tcp -m tcp --dport 1000 -j DNAT --to-destination 192.168.3.137:8080
iptables -t nat -A POSTROUTING -s 192.168.3.0/255.255.255.0 -d 192.168.3.137 -p tcp -m tcp --dport 8080 -j SNAT --to-source 192.168.3.9
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idp328"></a>41.2.7.2. Postrouting and IP Masquerading</h4></div></div></div>
			
			<pre class="screen">
			
iptables -P FORWARD ACCEPT
iptables -t nat -A POSTROUTING -o ppp0 -j MASQUERADE

iptables -t nat -A POSTROUTING -s 192.168.0.0/24 -j MASQUERADE
iptables -t nat -A POSTROUTING -s 192.168.1.0/24 -o eth0 -j MASQUERADE

sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
sudo iptables -t nat -I POSTROUTING -j MASQUERADE
sudo iptables -t nat -A POSTROUTING -j MASQUERADE -s 172.16.0.0/24 -d 0.0.0.0/0
sudo iptables -t nat -A POSTROUTING -j MASQUERADE -o eth1 -s 172.16.1.0/24 -d 0.0.0.0/0
sudo iptables -t nat -A POSTROUTING -j MASQUERADE -p tcp -o eth1 -s 172.16.1.0/24 -d 0.0.0.0/0
			
			</pre>
		</div>
	<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idp329"></a>41.2.7.3. Prerouting</h4></div></div></div>
		
		<pre class="screen">
iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -j DNAT --to 172.31.0.23:80
		</pre>
		<p>If you have a default policy of DROP in your FORWARD chain, you must append a rule to forward all incoming HTTP requests so that destination NAT routing is possible. To do this, use the following command:</p>
		<pre class="screen">
iptables -A FORWARD -i eth0 -p tcp --dport 80 -d 172.31.0.23 -j ACCEPT
		</pre>
		<p>This rule forwards all incoming HTTP requests from the firewall to the intended destination; the Apache HTTP Server behind the firewall.</p>
	</div>
	<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idp330"></a>41.2.7.4. DNAT and SNAT</h4></div></div></div>
		
		<pre class="screen">
echo 1 &gt; /proc/sys/net/ipv4/ip_forward
iptables -t nat -A PREROUTING -d 202.103.96.10 -j DNAT --to-destination 192.168.0.10
iptables -t nat -A POSTROUTING -s 192.168.0.0/24 -j SNAT --to-source 202.96.244.56
		</pre>
	</div>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idp331"></a>41.2.7.5. DMZ zone</h4></div></div></div>
			
			<pre class="screen">
#
# DMZ zone
#
$iptables -t nat -A PREROUTING -p TCP -m multiport -i eth0 --dport 22,25,113,80,8080 -j DNAT --to 10.0.0.10
$iptables -t nat -A PREROUTING -p UDP -i eth0 --dport 25 -j DNAT --to-destination 10.0.0.10
			</pre>
			<p>DNAT ppp0/eth0</p>
			<pre class="screen">
			
iptables -t nat -A PREROUTING -p tcp -i ppp0 --dport 80 -j DNAT --to-destination &lt;web server ip&gt;
iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -j DNAT --to-destination 10.0.4.2:80
			
			</pre>
		</div>
	</div>
	<div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="module"></a>41.2.8. Module(模块)</h3></div></div></div>
		
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="state"></a>41.2.8.1. IPTables and Connection Tracking</h4></div></div></div>
			
			<div class="literallayout"><p><br />
NEW — A packet requesting a new connection, such as an HTTP request.<br />
<br />
ESTABLISHED — A packet that is part of an existing connection.<br />
<br />
RELATED — A packet that is requesting a new connection but is part of an existing connection. For example, FTP uses port 21 to establish a connection, but data is transferred on a different port (typically port 20).<br />
<br />
INVALID — A packet that is not part of any connections in the connection tracking table.<br />
			</p></div>
			<p>放行已经启动的服务</p>
			<pre class="screen">
-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
			</pre>
			<pre class="screen">
iptables -A FORWARD -m state --state ESTABLISHED,RELATED -j ACCEPT
			</pre>
			<p>禁止新的端口listen，在防火墙启动后，不在允许启动任何新的端口。</p>
			<pre class="screen">
-A INPUT -m state --state INVALID,NEW -j DROP		
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="string"></a>41.2.8.2. string</h4></div></div></div>
			
			<pre class="screen">
iptables -m string -h
			</pre>
			<pre class="screen">
# iptables -A INPUT -p tcp --dport 80 -m string --algo bm --string "XXDD0S" -j DROP
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="connlimit"></a>41.2.8.3. connlimit</h4></div></div></div>
			
			<pre class="screen">
限制同一IP同时最多100个http连接
iptables -I INPUT -p tcp --syn --dport 80 -m connlimit --connlimit-above 100 -j REJECT

只允许每组C类IP同时100个http连接
iptables -p tcp --syn --dport 80 -m connlimit --connlimit-above 100 --connlimit-mask 24 -j REJECT

只允许每个IP同时5个80端口转发,超过的丢弃
iptables -I FORWARD -p tcp --syn --dport 80 -m connlimit --connlimit-above 5 -j DROP

限制某IP最多同时100个http连接
iptables -A INPUT -s xxx.xxx.xxx.xxx -p tcp --syn --dport 80 -m connlimit --connlimit-above 100 -j REJECT		
			</pre>
			<p>限制多少IP链接你的服务器</p>			
			<pre class="screen">
# allow 2 telnet connections per client host
iptables -p tcp --syn --dport 23 -m connlimit --connlimit-above 2 -j REJECT

# you can also match the other way around:
iptables -p tcp --syn --dport 23 -m connlimit ! --connlimit-above 2 -j ACCEPT

# limit the nr of parallel http requests to 16 per class C sized
# network (24 bit netmask)
iptables -p tcp --syn --dport 80 -m connlimit --connlimit-above 16 \
        --connlimit-mask 24 -j REJECT

# Skip proxy server IP 1.2.3.4 from this kind of limitations:
iptables -A INPUT -p tcp --syn --dport 80 -d ! 1.2.3.4 -m connlimit --connlimit-above 20 -j REJECT --reject-with tcp-reset

iptables -A INPUT -i ppp0 -p tcp --syn -m connlimit --connlimit-above 15 -j DROP
iptables -A INPUT -s 192.186.0.0/24 -p tcp --syn -m connlimit --connlimit-above 15 -j DROP
iptables -I INPUT -p tcp --dport 80 -m connlimit --connlimit-above 50 -j REJECT
			</pre>
			<pre class="screen">
iptables -A INPUT -p tcp -m state --state NEW -m tcp --dport 443 --syn -m connlimit --connlimit-above 50 -j REJECT
			</pre>
			<div class="example"><a id="idp1103"></a><p class="title"><strong>例 41.2. connlimit 实例</strong></p><div class="example-contents">
				
				<p>OS: CentOS</p>
				<pre class="screen">
# Generated by iptables-save v1.3.5 on Thu Mar  1 19:01:23 2012
*filter
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [548:1014604]
:RH-Firewall-1-INPUT - [0:0]
-A INPUT -j RH-Firewall-1-INPUT
-A FORWARD -j RH-Firewall-1-INPUT
-A OUTPUT -p udp -m udp --dport 53 -j ACCEPT
-A OUTPUT -p udp -m udp --dport 161 -j ACCEPT
-A OUTPUT -p udp -j DROP
-A RH-Firewall-1-INPUT -i lo -j ACCEPT
-A RH-Firewall-1-INPUT -p icmp -m icmp --icmp-type any -j ACCEPT
-A RH-Firewall-1-INPUT -p esp -j ACCEPT
-A RH-Firewall-1-INPUT -p ah -j ACCEPT
-A RH-Firewall-1-INPUT -d 224.0.0.251 -p udp -m udp --dport 5353 -j ACCEPT
-A RH-Firewall-1-INPUT -p tcp -m tcp --dport 3306 -j ACCEPT
-A RH-Firewall-1-INPUT -p tcp -m state --state NEW -m tcp --dport 22 -j ACCEPT
-A RH-Firewall-1-INPUT -p tcp -m state --state NEW -m tcp --dport 80 --tcp-flags FIN,SYN,RST,ACK SYN -m connlimit --connlimit-above 50 --connlimit-mask 32 -j REJECT --reject-with icmp-port-unreachable
-A RH-Firewall-1-INPUT -p tcp -m state --state NEW -m tcp --dport 443 --tcp-flags FIN,SYN,RST,ACK SYN -m connlimit --connlimit-above 50 --connlimit-mask 32 -j REJECT --reject-with icmp-port-unreachable
-A RH-Firewall-1-INPUT -p tcp -m state --state NEW -m tcp --dport 80 -j ACCEPT
-A RH-Firewall-1-INPUT -p tcp -m state --state NEW -m tcp --dport 443 -j ACCEPT
-A RH-Firewall-1-INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
-A RH-Firewall-1-INPUT -j REJECT --reject-with icmp-host-prohibited
COMMIT
# Completed on Thu Mar  1 19:01:23 2012
				</pre>
				<p>CentOS</p>
				<pre class="screen">
# Firewall configuration written by system-config-firewall
# Manual customization of this file is not recommended.
*filter
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
-A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
-A INPUT -p icmp -j ACCEPT
-A INPUT -i lo -j ACCEPT
-A INPUT -m state --state NEW -m tcp -p tcp --dport 22 -j ACCEPT
-A INPUT -p tcp -m state --state NEW -m tcp --dport 443 --tcp-flags FIN,SYN,RST,ACK SYN -m connlimit --connlimit-above 50 --connlimit-mask 32 -j REJECT --reject-with icmp-port-unreachable
-A INPUT -m state --state NEW -m tcp -p tcp --dport 443 -j ACCEPT
-A INPUT -j REJECT --reject-with icmp-host-prohibited
-A FORWARD -j REJECT --reject-with icmp-host-prohibited
COMMIT
				</pre>
			</div></div><br class="example-break" />
		</div>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="recent"></a>41.2.8.4. recent</h4></div></div></div>
			
			<p>限制每IP在一定的时间(比如60秒)内允许新建立最多100个http连接数</p>
			<pre class="screen">
iptables -A INPUT -p tcp --dport 80 -m recent --name BAD_HTTP_ACCESS --update --seconds 60 --hitcount 100 -j REJECT
iptables -A INPUT -p tcp --dport 80 -m recent --name BAD_HTTP_ACCESS --set -j ACCEPT				
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="limit"></a>41.2.8.5. limit</h4></div></div></div>
			
			<pre class="screen">
iptables -A INPUT -p icmp -m limit --limit 3/s -j LOG --log-level INFO --log-prefix "ICMP packet IN: "
			</pre>
			<pre class="screen">
iptables -N syn-flood
iptables -A INPUT -p tcp --syn -j syn-flood
iptables -I syn-flood -p tcp -m limit --limit 3/s --limit-burst 6 -j RETURN
iptables -A syn-flood -j REJECT
			</pre>
			<p>将丢弃包情况记入日志</p>
			<pre class="screen">
新建LOGGING链:
iptables -N LOGGING

将所有接收包导入LOGGING 链中：
iptables -A INPUT -j LOGGING

设置日志前缀与日志级别：
iptables -A LOGGING -m limit --limit 2/min -j LOG --log-prefix "IPTables Packet Dropped: " --log-level 7

最后将包倒向DROP，将包丢弃：
iptables -A LOGGING -j DROP			
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="nth"></a>41.2.8.6. nth</h4></div></div></div>
			
			<div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="idp332"></a>41.2.8.6.1. DNAT</h5></div></div></div>
				
				<p>利用iptables 实现负载均衡</p>
				<pre class="screen">
iptables -A PREROUTING -i eth0 -p tcp --dport 80 -m state --state NEW -m nth --counter 0 --every 3 --packet 0 -j DNAT --to-destination 192.168.1.101:80
iptables -A PREROUTING -i eth0 -p tcp --dport 80 -m state --state NEW -m nth --counter 0 --every 3 --packet 0 -j DNAT --to-destination 192.168.1.102:80
iptables -A PREROUTING -i eth0 -p tcp --dport 80 -m state --state NEW -m nth --counter 0 --every 3 --packet 0 -j DNAT --to-destination 192.168.1.103:80			
				</pre>
			</div>
			<div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="idp333"></a>41.2.8.6.2. SNAT</h5></div></div></div>
				
				<p>SNAT 是控制出去的IP</p>
				<pre class="screen">
				
# Generated by iptables-save v1.4.21 on Mon Nov 28 21:25:50 2016
*filter
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [27:3804]
-A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
-A INPUT -p icmp -j ACCEPT
-A INPUT -i lo -j ACCEPT
-A INPUT -p tcp -m state --state NEW -m tcp --dport 22 -j ACCEPT
-A INPUT -p tcp -m state --state NEW -m tcp --dport 25 -j ACCEPT
-A INPUT -s 47.90.44.87 -p tcp -m state --state NEW -m tcp --dport 10050 -j ACCEPT
-A INPUT -j REJECT --reject-with icmp-host-prohibited
-A FORWARD -j REJECT --reject-with icmp-host-prohibited
COMMIT
# Completed on Mon Nov 28 21:25:50 2016
# Generated by iptables-save v1.4.21 on Mon Nov 28 21:25:50 2016
*nat
:PREROUTING ACCEPT [0:0]
:INPUT ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]
-A POSTROUTING -o enp2s0f0 -p tcp -m state --state NEW -m tcp -m statistic --mode nth --every 5 --packet 0 -j SNAT --to-source 104.23.14.186
-A POSTROUTING -o enp2s0f0 -p tcp -m state --state NEW -m tcp -m statistic --mode nth --every 5 --packet 0 -j SNAT --to-source 104.23.14.187
-A POSTROUTING -o enp2s0f0 -p tcp -m state --state NEW -m tcp -m statistic --mode nth --every 5 --packet 0 -j SNAT --to-source 104.23.14.188
-A POSTROUTING -o enp2s0f0 -p tcp -m state --state NEW -m tcp -m statistic --mode nth --every 5 --packet 0 -j SNAT --to-source 104.23.14.189
-A POSTROUTING -o enp2s0f0 -p tcp -m state --state NEW -m tcp -m statistic --mode nth --every 5 --packet 0 -j SNAT --to-source 104.23.14.190
COMMIT
# Completed on Mon Nov 28 21:25:50 2016
				
				</pre>
				<p>使用 curl 测试</p>
				<pre class="screen">
				
$ curl http://ip.cn
$ curl http://ip.cn
$ curl http://ip.cn
$ curl http://ip.cn
$ curl http://ip.cn
				
				</pre>
				<p>你会发现每次访问的IP均不同</p>
			</div>
		</div>
		<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idp334"></a>41.2.8.7. random 模块</h4></div></div></div>
			
			<pre class="screen">
			
# iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -m state --state NEW -m statistic --mode random --probability .25 -j DNAT --to-destination 10.10.0.1:80
# iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -m state --state NEW -m statistic --mode random --probability .25 -j DNAT --to-destination 10.10.0.2:80
# iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -m state --state NEW -m statistic --mode random --probability .25 -j DNAT --to-destination 10.10.0.3:80
# iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -m state --state NEW -m statistic --mode random --probability .25 -j DNAT --to-destination 10.10.0.4:80
# iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -m state --state NEW -m statistic --mode random --probability .25 -j DNAT --to-destination 10.10.0.5:80
			
			</pre>
		</div>
	</div>
	<div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="ipv6"></a>41.2.9. IPV6</h3></div></div></div>
		
		<pre class="screen">
		
[root@linux iptables]# modprobe ipv6
[root@linux iptables]# modprobe ip6_tables
[root@linux iptables]# [ ! -f /proc/net/ip6_tables_names ] &amp;&amp; echo "Current kernel doesn't support? 'ip6tables' firewalling (IPv6)!"
[root@linux iptables]# ip6tables -A INPUT -i eth0 -p tcp -s 3ffe:ffff:100::1/128 --dport 22 -j ACCEPT
		
		</pre>
	</div>
	<div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="iptables-xml"></a>41.2.10. iptables-xml - Convert iptables-save format to XML</h3></div></div></div>
		
	</div>
	<div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="iptables.tools"></a>41.2.11. access.log IP封锁脚本</h3></div></div></div>
		
		<pre class="screen">
#!/bin/bash

ACCCESS_LOG=/tmp/myid.access.log
TIMEPOINT='23/May/2012'
BLACKLIST=/var/tmp/black
WHITELIST=/var/tmp/white
if [ ! -f ${BLACKLIST} ]; then
    touch ${BLACKLIST}
fi

if [ ! -f ${WHITELIST} ]; then
    touch ${WHITELIST}
fi

for deny in $(grep ${TIMEPOINT} ${ACCCESS_LOG} | awk '{print $1}' | awk -F'.' '{print $1"."$2"."$3"."$4}' | sort | uniq -c | sort -r -n | head -n 30| awk '{print $2}')
do

    if [ $(grep -c $deny ${WHITELIST}) -ne 0 ]; then
        echo 'Allow IP:' $deny
	continue
    fi

    if [ $(grep -c $deny ${BLACKLIST}) -eq 0 ] ; then

	echo 'Deny IP:' $deny
        echo $deny &gt;&gt; ${BLACKLIST}
        iptables -I INPUT -p tcp --dport 443 -s $deny -j DROP
        iptables -I INPUT -p tcp --dport 80 -s $deny -j DROP
    fi
done
		</pre>
	</div>
	
	<div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="example"></a>41.2.12. Example</h3></div><div><h4 class="subtitle">Common Chains Filtering</h4></div></div></div>
	
	
	
	<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="example.input"></a>41.2.12.1. INPUT Rule Chains</h4></div></div></div>
		
		<div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="idp335"></a>41.2.12.1.1. OpenSSH</h5></div></div></div>
			
			<pre class="screen">
# Accept tcp packets on destination port 22 (SSH)
 iptables -A INPUT -p tcp --dport 22 -j ACCEPT

# Accept tcp packets on destination port 22 (SSH) from private LAN
 iptables -A INPUT -p tcp -s 192.168.0.0/24 --dport 22 -j ACCEPT
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="idp336"></a>41.2.12.1.2. FTP</h5></div></div></div>
			
			<pre class="screen">
/sbin/iptables -A INPUT -p tcp --dport 21 -j ACCEPT
/sbin/iptables -A INPUT -p tcp --dport 20 -j ACCEPT
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="idp337"></a>41.2.12.1.3. DNS</h5></div></div></div>
			
			<pre class="screen">
iptables -A INPUT -i eth0 -p tcp --dport 53   -j ACCEPT
iptables -A INPUT -i eth0 -p udp --dport 53   -j ACCEPT
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="idp338"></a>41.2.12.1.4. WWW</h5></div></div></div>
			
			<pre class="screen">
# WWW
/sbin/iptables -A INPUT -p tcp --dport 80 -j ACCEPT
# HTTPS
/sbin/iptables -A INPUT -p tcp --dport 443 -j ACCEPT
# Tomcat
/sbin/iptables -A INPUT -p tcp --dport 8080 -j ACCEPT
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="idp339"></a>41.2.12.1.5. SOCKS5</h5></div></div></div>
			
			<pre class="screen">
/sbin/iptables -A INPUT -p tcp --dport 1080 -j ACCEPT
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="idp340"></a>41.2.12.1.6. Mail Server</h5></div></div></div>
			
			<pre class="screen">
# SMTP
/sbin/iptables -A INPUT -p tcp --dport 25 -j ACCEPT
# SMTPS
/sbin/iptables -A INPUT -p tcp --dport 465 -j ACCEPT
# POP3
/sbin/iptables -A INPUT -p tcp --dport 110 -j ACCEPT
# POP3S
/sbin/iptables -A INPUT -p tcp --dport 995 -j ACCEPT
# IMAP
/sbin/iptables -A INPUT -p tcp --dport 143 -j ACCEPT
# IMAPS
/sbin/iptables -A INPUT -p tcp --dport 993 -j ACCEPT
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="idp341"></a>41.2.12.1.7. MySQL</h5></div></div></div>
			
			<pre class="screen">
/sbin/iptables -A INPUT -p tcp --dport 3306 -j ACCEPT
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="idp342"></a>41.2.12.1.8. PostgreSQL</h5></div></div></div>
			
			<pre class="screen">
/sbin/iptables -A INPUT -p tcp --dport 5432 -j ACCEPT
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="idp343"></a>41.2.12.1.9. DHCP</h5></div></div></div>
			
			<pre class="screen">
iptables -A INPUT -p UDP -i eth0 --dport 67 -j ACCEPT
iptables -A INPUT -p UDP -i eth0 --dport 68 -j ACCEPT
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="idp344"></a>41.2.12.1.10. Samba</h5></div></div></div>
			
			<pre class="screen">
/sbin/iptables -A INPUT -p tcp -s 192.168.0.0/24 --dport 137 -j ACCEPT
iptables -A INPUT -p tcp -s 192.168.0.0/24 --dport 145 -j ACCEPT
iptables -A INPUT -p udp -s 192.168.0.0/24 --dport 138 -j ACCEPT
iptables -A INPUT -p udp -s 192.168.0.0/24 --dport 139 -j ACCEPT
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="idp345"></a>41.2.12.1.11. ICMP</h5></div></div></div>
			
			<div class="literallayout"><p><br />
accept_redirects<br />
# echo "0" &gt; /proc/sys/net/ipv4/conf/all/accept_redirects<br />
or<br />
# sysctl net.ipv4.conf.all.accept_redirects="0"<br />
<br />
			</p></div>
			<pre class="screen">
使自己不能ping 通 127.0.0.1
iptables -A INPUT -s 127.0.0.1 -p icmp -j DROP

192.168.0.0/24 网段无法ping能本机
iptables -A INPUT -s 192.168.0.0/24 -p icmp -j DROP

禁所有机器
# iptables -A INPUT -s 0/0 -p icmp -j DROP

# ICMP(PING) 接受 ! echo-request
iptables -A INPUT -p icmp --icmp-type ! echo-request -j ACCEPT
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="idp346"></a>41.2.12.1.12. 禁止IP访问自己</h5></div></div></div>
			
			<pre class="screen">
$sudo iptables -A INPUT -s 192.168.0.253 -j DROP
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="idp347"></a>41.2.12.1.13. DENY</h5></div></div></div>
			
			<pre class="screen">
iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
iptables -A INPUT -j DROP
			</pre>
		</div>
	</div>
	<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="example.output"></a>41.2.12.2. OUTPUT Rule Chains</h4></div></div></div>
		
		<div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="idp348"></a>41.2.12.2.1. outbound</h5></div></div></div>
			
			<pre class="screen">
# Open ports for outbound established connections
$IPT -A OUTPUT -p tcp -s $NET -d 0/0 --destination-port 1:65535 -j ACCEPT
$IPT -A OUTPUT -p udp -s $NET -d 0/0 --destination-port 1:65535 -j ACCEPT
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="idp349"></a>41.2.12.2.2. ICMP</h5></div></div></div>
			
			<div class="literallayout"><p><br />
本地不允许ping 192.168.0.0/24<br />
iptables -A OUTPUT -s 192.168.0.0/24 -p icmp -j DROP<br />
<br />
禁所本地ping任何机器<br />
# iptables -A OUTPUT -s 0/0 -p icmp -j DROP<br />
<br />
# ICMP(PING) 接受 ! echo-request<br />
iptables -A OUTPUT -p icmp --icmp-type ! echo-request -j ACCEPT<br />
			</p></div>
		</div>
		<div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="idp350"></a>41.2.12.2.3. NFS</h5></div></div></div>
			
			<pre class="screen">
iptables -A OUTPUT -p tcp --dport 2049 -j REJECT
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="idp351"></a>41.2.12.2.4. SSH</h5></div></div></div>
			
			<pre class="screen">
iptables -A OUTPUT -p tcp -m multiport --dports 22 -j REJECT
			</pre>
		</div>
		<div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="idp352"></a>41.2.12.2.5. 禁止自己访问某个IP</h5></div></div></div>
			
			<pre class="screen">
# iptables -A OUTPUT -d 192.168.0.253 -j DROP
iptables -A OUTPUT -p udp -j DROP
iptables -A OUTPUT -d 125.211.210.46 -j DROP
			</pre>
		</div>
	</div>
	<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="example.forward"></a>41.2.12.3. Forward</h4></div></div></div>
		
		<pre class="screen">
iptables -A FORWARD -i eth1 -j ACCEPT
		</pre>
		<pre class="screen">
# Network 1 forwarded outgoing client request to network 2
iptables -A FORWARD -i eth1 -p tcp -s 192.168.1.0/24 -d 192.168.2.0/24 -m state --state NEW,ESTABLISHED -j ACCEPT
iptables -A FORWARD -o eth1 -p tcp -s 192.168.2.0/24 -d 192.168.1.0/24 -m state --state ESTABLISHED,RELATED -j ACCEPT
		</pre>
		<div class="section"><div class="titlepage"><div><div><h5 class="title"><a id="idp353"></a>41.2.12.3.1. TCPMSS</h5></div></div></div>
			
			<pre class="screen">
iptables -A FORWARD -p tcp --tcp-flags SYN,RST SYN -j TCPMSS --clamp-mss-to-pmtu
			</pre>
		</div>
	</div>
	<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idp354"></a>41.2.12.4. Malicious Software and Spoofed IP Addresses</h4></div></div></div>
		
		<pre class="screen">
# The following rules drop all TCP traffic that attempts to use port 31337:
iptables -A OUTPUT -o eth0 -p tcp --dport 31337 --sport 31337 -j DROP
iptables -A FORWARD -o eth0 -p tcp --dport 31337 --sport 31337 -j DROP
		</pre>
	</div>
	
	<div class="section"><div class="titlepage"><div><div><h4 class="title"><a id="idp355"></a>41.2.12.5. /etc/sysconfig/iptables 操作系统默认配置</h4></div></div></div>
		
		<div class="example"><a id="idp1104"></a><p class="title"><strong>例 41.3. CentOS 5.6</strong></p><div class="example-contents">
			
			<pre class="screen">
# iptables-save
# Generated by iptables-save v1.3.5 on Sat Dec 31 18:29:51 2011
*filter
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [1516:131654]
:RH-Firewall-1-INPUT - [0:0]
-A INPUT -j RH-Firewall-1-INPUT
-A FORWARD -j RH-Firewall-1-INPUT
-A RH-Firewall-1-INPUT -i lo -j ACCEPT
-A RH-Firewall-1-INPUT -i eth0 -j ACCEPT
-A RH-Firewall-1-INPUT -p icmp -m icmp --icmp-type any -j ACCEPT
-A RH-Firewall-1-INPUT -p esp -j ACCEPT
-A RH-Firewall-1-INPUT -p ah -j ACCEPT
-A RH-Firewall-1-INPUT -d 224.0.0.251 -p udp -m udp --dport 5353 -j ACCEPT
-A RH-Firewall-1-INPUT -p udp -m udp --dport 631 -j ACCEPT
-A RH-Firewall-1-INPUT -p tcp -m tcp --dport 631 -j ACCEPT
-A RH-Firewall-1-INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
-A RH-Firewall-1-INPUT -p tcp -m state --state NEW -m tcp --dport 1521 -j ACCEPT
-A RH-Firewall-1-INPUT -p tcp -m state --state NEW -m tcp --dport 3306 -j ACCEPT
-A RH-Firewall-1-INPUT -p tcp -m state --state NEW -m tcp --dport 22 -j ACCEPT
-A RH-Firewall-1-INPUT -p tcp -m state --state NEW -m tcp --dport 23 -j ACCEPT
-A RH-Firewall-1-INPUT -p tcp -m state --state NEW -m tcp --dport 25 -j ACCEPT
-A RH-Firewall-1-INPUT -p tcp -m state --state NEW -m tcp --dport 80 -j ACCEPT
-A RH-Firewall-1-INPUT -p tcp -m state --state NEW -m tcp --dport 21 -j ACCEPT
-A RH-Firewall-1-INPUT -p tcp -m state --state NEW -m tcp --dport 443 -j ACCEPT
-A RH-Firewall-1-INPUT -p udp -m state --state NEW -m udp --dport 137 -j ACCEPT
-A RH-Firewall-1-INPUT -p udp -m state --state NEW -m udp --dport 138 -j ACCEPT
-A RH-Firewall-1-INPUT -p tcp -m state --state NEW -m tcp --dport 139 -j ACCEPT
-A RH-Firewall-1-INPUT -p tcp -m state --state NEW -m tcp --dport 445 -j ACCEPT
-A RH-Firewall-1-INPUT -p tcp -m state --state NEW -m tcp --dport 2049 -j ACCEPT
-A RH-Firewall-1-INPUT -j REJECT --reject-with icmp-host-prohibited
COMMIT
# Completed on Sat Dec 31 18:29:51 2011
			</pre>
			<pre class="screen">
# Firewall configuration written by system-config-securitylevel
# Manual customization of this file is not recommended.
*filter
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:RH-Firewall-1-INPUT - [0:0]
-A INPUT -j RH-Firewall-1-INPUT
-A FORWARD -j RH-Firewall-1-INPUT
-A RH-Firewall-1-INPUT -i lo -j ACCEPT
-A RH-Firewall-1-INPUT -i eth3 -j ACCEPT
-A RH-Firewall-1-INPUT -i eth2 -j ACCEPT
-A RH-Firewall-1-INPUT -i eth0 -j ACCEPT
-A RH-Firewall-1-INPUT -i eth1 -j ACCEPT
-A RH-Firewall-1-INPUT -p icmp --icmp-type any -j ACCEPT
-A RH-Firewall-1-INPUT -p 50 -j ACCEPT
-A RH-Firewall-1-INPUT -p 51 -j ACCEPT
-A RH-Firewall-1-INPUT -p udp --dport 5353 -d 224.0.0.251 -j ACCEPT
-A RH-Firewall-1-INPUT -p udp -m udp --dport 631 -j ACCEPT
-A RH-Firewall-1-INPUT -p tcp -m tcp --dport 631 -j ACCEPT
-A RH-Firewall-1-INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
-A RH-Firewall-1-INPUT -m state --state NEW -m tcp -p tcp --dport 22 -j ACCEPT
-A RH-Firewall-1-INPUT -m state --state NEW -m tcp -p tcp --dport 80 -j ACCEPT
-A RH-Firewall-1-INPUT -m state --state NEW -m tcp -p tcp --dport 443 -j ACCEPT
-A RH-Firewall-1-INPUT -j REJECT --reject-with icmp-host-prohibited
COMMIT


# Generated by iptables-save v1.3.5 on Wed May 23 10:58:21 2012
*filter
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [43:8584]
:RH-Firewall-1-INPUT - [0:0]
-A INPUT -j RH-Firewall-1-INPUT
-A FORWARD -j RH-Firewall-1-INPUT
-A RH-Firewall-1-INPUT -i lo -j ACCEPT
-A RH-Firewall-1-INPUT -i eth3 -j ACCEPT
-A RH-Firewall-1-INPUT -i eth2 -j ACCEPT
-A RH-Firewall-1-INPUT -i eth0 -j ACCEPT
-A RH-Firewall-1-INPUT -i eth1 -j ACCEPT
-A RH-Firewall-1-INPUT -p icmp -m icmp --icmp-type any -j ACCEPT
-A RH-Firewall-1-INPUT -p esp -j ACCEPT
-A RH-Firewall-1-INPUT -p ah -j ACCEPT
-A RH-Firewall-1-INPUT -d 224.0.0.251 -p udp -m udp --dport 5353 -j ACCEPT
-A RH-Firewall-1-INPUT -p udp -m udp --dport 631 -j ACCEPT
-A RH-Firewall-1-INPUT -p tcp -m tcp --dport 631 -j ACCEPT
-A RH-Firewall-1-INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT
-A RH-Firewall-1-INPUT -p tcp -m state --state NEW -m tcp --dport 22 -j ACCEPT
-A RH-Firewall-1-INPUT -p tcp -m state --state NEW -m tcp --dport 80 -j ACCEPT
-A RH-Firewall-1-INPUT -p tcp -m state --state NEW -m tcp --dport 443 --tcp-flags FIN,SYN,RST,ACK SYN -m connlimit --connlimit-above 50 --connlimit-mask 32 -j REJECT --reject-with icmp-port-unreachable
-A RH-Firewall-1-INPUT -p tcp -m state --state NEW -m tcp --dport 443 -j ACCEPT
-A RH-Firewall-1-INPUT -j REJECT --reject-with icmp-host-prohibited
COMMIT
# Completed on Wed May 23 10:58:21 2012
			</pre>
		</div></div><br class="example-break" />
	</div>
	
</div>

</div><div xmlns="" id="disqus_thread"></div><script xmlns="">

var disqus_config = function () {
this.page.url = "http://www.netkiller.cn";  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = 'netkiller'; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};

(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = '//netkiller.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script><noscript xmlns="">Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript><br xmlns="" /><script xmlns="" type="text/javascript" id="clustrmaps" src="//cdn.clustrmaps.com/map_v2.js?u=r5HG&amp;d=9mi5r_kkDC8uxG8HuY3p4-2qgeeVypAK9vMD-2P6BYM"></script><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="index.html">上一页</a> </td><td width="20%" align="center"><a accesskey="u" href="index.html">上一级</a></td><td width="40%" align="right"> <a accesskey="n" href="ulogd.html">下一页</a></td></tr><tr><td width="40%" align="left" valign="top">第 41 章 Firewall </td><td width="20%" align="center"><a accesskey="h" href="../../index.html">起始页</a></td><td width="40%" align="right" valign="top"> 41.3. ulogd - The Netfilter Userspace Logging Daemon</td></tr></table></div><script xmlns="">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-11694057-1', 'auto');
  ga('send', 'pageview');

</script><script xmlns="" async="async">
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?93967759a51cda79e49bf4e34d0b0f2c";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script><script xmlns="" async="async">
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script><script xmlns="" type="text/javascript" src="/js/q.js" async="async"></script></body></html>